<!DOCTYPE html>
<html lang="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betalingsstatus | Min Side</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .status-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .icon-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .error {
            background: #ffebee;
            color: #c62828;
        }

        .processing {
            background: #e3f2fd;
            color: #1565c0;
        }

        h1 {
            margin: 0 0 10px;
            font-size: 24px;
            color: #333;
        }

        p {
            color: #666;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #1B4965;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #12344d;
        }
    </style>
    <script src="https://js.stripe.com/v3/"></script>
<!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-orange': '#f39c12',
                        'primary-red': '#e74c3c',
                        'text-dark': '#333333',
                    }
                }
            }
        }
    </script>
</head>

<body>

    <div class="status-card" id="status-card">
        <div class="icon-circle processing" id="status-icon">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <h1 id="status-title">Sjekker betaling...</h1>
        <p id="status-message">Vennligst vent mens vi bekrefter betalingen din med banken.</p>
        <a href="index.html" class="btn hidden" id="action-btn">Tilbake til Min Side</a>
    </div>

    <!-- Firebase SDK (for logging if needed) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>

    <script>
        // Initialize Stripe
        // TODO: Move key to config or generic init
        const stripe = Stripe("pk_live_51Pab8rAL393JGrO9bTUitYflDKlHGpLiqZCCBp0dCzBEV3ZFxARFfK6MgWraehq7i79tJHPIEzlpMwPiT2K3HsiZ00gJ1TQ71Y");

        async function verifyPayment() {
            const clientSecret = new URLSearchParams(window.location.search).get("payment_intent_client_secret");
            const statusCard = document.getElementById('status-card');
            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-title');
            const message = document.getElementById('status-message');
            const btn = document.getElementById('action-btn');

            if (!clientSecret) {
                // No payment intent in URL, redirect or show error
                icon.className = 'icon-circle error';
                icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                title.innerText = "Ingen betaling funnet";
                message.innerText = "Vi finner ingen betalingsinformasjon i linken. Vennligst start betalingen på nytt.";
                btn.href = "index.html#courses";
                btn.innerText = "Gå til Kurs";
                btn.classList.remove('hidden');
                return;
            }

            try {
                // Retrieve the PaymentIntent
                const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);

                switch (paymentIntent.status) {
                    case "succeeded":
                        icon.className = 'icon-circle success';
                        icon.innerHTML = '<i class="fas fa-check"></i>';
                        title.innerText = "Betaling fullført!";
                        message.innerText = "Takk for din betaling! Kurset er nå tilgjengelig på din profil.";
                        btn.innerText = "Start Kurset";
                        btn.href = "index.html#courses";

                        // Optional: Log success to backend here if relying on client-side (NOT SECURE for critical logic)
                        // Best practice: Rely on Webhook for access granting
                        break;

                    case "processing":
                        icon.className = 'icon-circle processing';
                        icon.innerHTML = '<i class="fas fa-sync fa-spin"></i>';
                        title.innerText = "Behandler betaling...";
                        message.innerText = "Betalingen behandles fortsatt av banken (f.eks. Vipps). Vi oppdaterer statusen snart.";
                        // Refresh page after 5 seconds to check again
                        setTimeout(() => location.reload(), 5000);
                        return; // Don't show button yet

                    case "requires_payment_method":
                        icon.className = 'icon-circle error';
                        icon.innerHTML = '<i class="fas fa-times"></i>';
                        title.innerText = "Betaling feilet";
                        message.innerText = "Betalingen ble ikke gjennomført. Vennligst prøv en annen betalingsmetode.";
                        btn.innerText = "Prøv igjen";
                        btn.href = "index.html#payment"; // Adjust link
                        break;

                    default:
                        icon.className = 'icon-circle error';
                        icon.innerHTML = '<i class="fas fa-question"></i>';
                        title.innerText = "Noe gikk galt";
                        message.innerText = "Status: " + paymentIntent.status;
                        btn.innerText = "Kontakt Kundeservice";
                        btn.href = "../kontakt.html";
                        break;
                }
                btn.classList.remove('hidden');

            } catch (error) {
                console.error("Error retrieving payment intent:", error);
                icon.className = 'icon-circle error';
                icon.innerHTML = '<i class="fas fa-server"></i>';
                title.innerText = "Systemfeil";
                message.innerText = "Kunne ikke sjekke status. Vennligst kontakt oss.";
            }
        }

        // Run verification on load
        verifyPayment();
    </script>
</body>

</html>