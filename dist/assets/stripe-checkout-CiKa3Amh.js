const d=Stripe("pk_live_51Pab8rAL393JGrO9bTUitYflDKlHGpLiqZCCBp0dCzBEV3ZFxARFfK6MgWraehq7i79tJHPIEzlpMwPiT2K3HsiZ00gJ1TQ71Y");let l;async function f(e,t={}){c(!0);try{const n=await fetch("https://us-central1-his-kingdom-ministry.cloudfunctions.net/createPaymentIntent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:e,currency:"nok",customerDetails:t})});if(!n.ok){const m=await n.json();throw new Error(m.error||`Server error: ${n.status}`)}const{clientSecret:r}=await n.json(),a={appearance:{theme:"stripe",variables:{colorPrimary:"#FFA500",colorBackground:"#ffffff",colorText:"#30313d",colorDanger:"#df1b41",fontFamily:"Inter, system-ui, sans-serif",spacingUnit:"4px",borderRadius:"6px"}},clientSecret:r};l=d.elements(a);const i={layout:"tabs"};l.create("payment",i).mount("#payment-element"),document.getElementById("stripe-checkout-container").style.display="block",document.getElementById("stripe-checkout-container").scrollIntoView({behavior:"smooth"})}catch(n){console.error("Stripe initialization failed:",n),alert("Kunne ikke starte betalingen: "+n.message+". Vennligst prøv igjen senere."),window.hkmLogger&&window.hkmLogger.error(`Payment Init Failed: ${n.message}`)}finally{c(!1)}}async function p(e,t={}){e&&e.preventDefault(),c(!0);const{customReturnUrl:n,billingDetails:r}=t,a={return_url:n||window.location.href.split("?")[0]};r&&(a.payment_method_data={billing_details:r});const{error:i}=await d.confirmPayment({elements:l,confirmParams:a});i&&(i.type==="card_error"||i.type==="validation_error"?o(i.message):o("En uventet feil oppstod: "+i.message)),c(!1)}async function u(){const e=new URLSearchParams(window.location.search).get("payment_intent_client_secret");if(!e)return;const{paymentIntent:t}=await d.retrievePaymentIntent(e);switch(t.status){case"succeeded":o("Betalingen var vellykket! Takk for din gave."),await y(t);break;case"processing":o("Betalingen behandles.");break;case"requires_payment_method":o("Betalingen feilet, vennligst prøv igjen.");break;default:o("Noe gikk galt.");break}}async function y(e){try{if(typeof firebase>"u")return;const t=firebase.firestore(),r=firebase.auth().currentUser,s=t.collection("donations").doc(e.id);if((await s.get()).exists)return;await s.set({paymentIntentId:e.id,amount:e.amount,currency:e.currency,status:e.status,timestamp:firebase.firestore.FieldValue.serverTimestamp(),uid:r?r.uid:null,email:r?r.email:e.receipt_email||null,type:"Donation",method:e.payment_method_types[0]||"card"}),console.log("Donation recorded successfully")}catch(t){console.error("Error recording donation:",t)}}function o(e){const t=document.querySelector("#payment-message");t.classList.remove("hidden"),t.textContent=e,setTimeout(function(){t.classList.add("hidden"),t.textContent=""},4e3)}function c(e){e?(document.querySelector("#submit-payment").disabled=!0,document.querySelector("#spinner").classList.remove("hidden"),document.querySelector("#button-text").classList.add("hidden")):(document.querySelector("#submit-payment").disabled=!1,document.querySelector("#spinner").classList.add("hidden"),document.querySelector("#button-text").classList.remove("hidden"))}window.initializeStripe=f;window.checkStatus=u;window.handleStripeSubmit=p;document.addEventListener("DOMContentLoaded",u);
