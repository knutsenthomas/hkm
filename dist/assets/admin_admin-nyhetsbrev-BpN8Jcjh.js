import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css                      *//* empty css                      */import"./admin-header-61a71NKR.js";class r{constructor(){this.toastContainer=null,this.init()}init(){document.querySelector(".toast-container")?this.toastContainer=document.querySelector(".toast-container"):(this.toastContainer=document.createElement("div"),this.toastContainer.className="toast-container",document.body.appendChild(this.toastContainer))}show(e,t="success",i=5e3){this.toastContainer||this.init();const s=document.createElement("div");s.className=`toast ${t}`;const n=t==="success"?"check_circle":t==="error"?"error":t==="warning"?"warning":"info";s.innerHTML=`
            <span class="material-symbols-outlined toast-icon">${n}</span>
            <div class="toast-content">
                <p class="toast-message">${e}</p>
            </div>
            <button class="toast-close">
                <i class="fas fa-times"></i>
            </button>
            <div class="toast-progress">
                <div class="toast-progress-bar" style="animation-duration: ${i}ms"></div>
            </div>
        `,this.toastContainer.appendChild(s);const a=setTimeout(()=>{this.remove(s)},i);s.querySelector(".toast-close").addEventListener("click",o=>{o.stopPropagation(),clearTimeout(a),this.remove(s)}),s.addEventListener("click",()=>{clearTimeout(a),this.remove(s)})}remove(e){e.parentElement&&(e.classList.add("removing"),setTimeout(()=>{e.parentElement&&this.toastContainer.removeChild(e)},300))}}window.hkm_notifications=new r;window.showToast=(l,e,t)=>window.hkm_notifications.show(l,e,t);window.showAlert=(l,e,t)=>window.hkm_notifications.show(l,e,t);class d{constructor(){this.blocks=[],this.currentView="desktop",this.activeTab="add",this.activeTheme="default",this.themes={default:{name:"Default",outerBg:"#f8fafc",innerBg:"#ffffff",font:"'Inter', sans-serif",accent:"#3b82f6"},light:{name:"Light",outerBg:"#ffffff",innerBg:"#f8fafc",font:"'Outfit', sans-serif",accent:"#0f172a"},earthy:{name:"Earthy",outerBg:"#e9edc9",innerBg:"#fefae0",font:"'Georgia', serif",accent:"#606c38"},cherry:{name:"Cherry",outerBg:"#fff5f5",innerBg:"#ffffff",font:"'Playfair Display', serif",accent:"#9b2c2c"},umber:{name:"Umber",outerBg:"#3e2723",innerBg:"#5d4037",font:"'Roboto', sans-serif",accent:"#d7ccc8"}},this.backgrounds={outer:{color:"#f8fafc",pattern:"none"},inner:{color:"#ffffff"}},this.isRecipientsDrawerOpen=!1,this.activeImageBlockId=null,this.activeColumnIndex=null,this.selectedSegments=new Set,this.selectedLabels=new Set,this.selectedUserEmails=new Set,this.totalUsers=0,this.subscribersCount=0,this.init()}switchTab(e){this.activeTab=e,document.querySelectorAll(".nav-icon-btn").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),document.querySelectorAll(".tab-pane").forEach(t=>{t.classList.toggle("active",t.id===`tab-${e}`)})}updateBackground(e,t,i){this.backgrounds[e][t]=i,this.applyBackgrounds()}applyBackgrounds(){const e=document.getElementById("canvas-container"),t=document.getElementById("newsletter-canvas");if(!e||!t)return;const i=this.backgrounds.outer;e.style.backgroundColor=i.color,i.pattern==="dots"?(e.style.backgroundImage="radial-gradient(#cbd5e1 1px, transparent 1px)",e.style.backgroundSize="10px 10px"):i.pattern==="lines"?(e.style.backgroundImage="repeating-linear-gradient(45deg, rgba(0,0,0,0.02), rgba(0,0,0,0.02) 10px, transparent 10px, transparent 11px)",e.style.backgroundSize="auto"):i.pattern==="gradient"?(e.style.backgroundImage="radial-gradient(circle, transparent 20%, rgba(0,0,0,0.05) 100%)",e.style.backgroundSize="auto"):e.style.backgroundImage="none",t.style.backgroundColor=this.backgrounds.inner.color}setTheme(e){const t=this.themes[e];if(!t)return;this.activeTheme=e,this.backgrounds.outer.color=t.outerBg,this.backgrounds.inner.color=t.innerBg,this.applyBackgrounds();const i=document.getElementById("newsletter-canvas");i&&(i.style.fontFamily=t.font),document.querySelectorAll(".color-swatch, .pattern-item").forEach(s=>s.classList.remove("active")),console.log(`Theme set to: ${t.name}`)}async init(){console.log("Nyhetsbrevbygger Initializing...");const e=setInterval(()=>{window.firebaseService&&window.firebaseService.isInitialized&&(clearInterval(e),this.startAuthListener())},100);this.setupEventListeners(),this.applyBackgrounds(),this.renderCanvas()}isMobileViewport(){return window.matchMedia("(max-width: 1366px)").matches}openToolsPanel(e=null){this.isMobileViewport()&&(e&&this.switchTab(e),document.body.classList.remove("builder-tools-menu-open"),document.body.classList.add("builder-tools-panel-open"))}closeToolsUi(){document.body.classList.remove("builder-tools-menu-open"),document.body.classList.remove("builder-tools-panel-open");const e=document.getElementById("builder-tools-fab");e&&e.classList.remove("active")}setupToolsFab(){const e=document.getElementById("builder-tools-fab"),t=document.getElementById("builder-tools-menu"),i=document.getElementById("builder-tools-backdrop");!e||!t||!i||(e.addEventListener("click",s=>{if(s.stopPropagation(),document.body.classList.contains("builder-tools-panel-open")){this.closeToolsUi();return}const n=document.body.classList.toggle("builder-tools-menu-open");e.classList.toggle("active",n),console.log("Newsletter FAB Toggle:",n)}),t.querySelectorAll("[data-tool-type]").forEach(s=>{s.addEventListener("click",()=>{const n=s.dataset.toolType;this.addBlock(n),this.closeToolsUi()})}),i.addEventListener("click",()=>this.closeToolsUi()),document.addEventListener("keydown",s=>{s.key==="Escape"&&this.closeToolsUi()}),window.addEventListener("resize",()=>{this.isMobileViewport()||(this.closeToolsUi(),document.body.classList.remove("builder-recipients-open"))}))}startAuthListener(){window.firebaseService.onAuthChange(e=>{e?this.loadTemplates():window.location.href="login.html"})}setupEventListeners(){this.setupToolsFab(),document.querySelectorAll(".nav-icon-btn").forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.tab;this.switchTab(a),this.isMobileViewport()&&this.openToolsPanel(a)})}),document.querySelectorAll(".theme-item").forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.theme;this.setTheme(a),document.querySelectorAll(".theme-item").forEach(o=>o.classList.remove("active")),n.classList.add("active")})}),document.querySelectorAll(".block-tool").forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.type;this.addBlock(a),this.isMobileViewport()&&this.closeToolsUi()})}),document.querySelectorAll("#outer-bg-palette .color-swatch").forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.color;this.updateBackground("outer","color",a),document.querySelectorAll("#outer-bg-palette .color-swatch").forEach(o=>o.classList.remove("active")),n.classList.add("active")})}),document.querySelectorAll(".pattern-item").forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.pattern;this.updateBackground("outer","pattern",a),document.querySelectorAll(".pattern-item").forEach(o=>o.classList.remove("active")),n.classList.add("active")})});const e=document.getElementById("customize-inner-bg");e&&e.addEventListener("click",()=>{const n=prompt("Velg farge for indre bakgrunn (hex):",this.backgrounds.inner.color);n&&this.updateBackground("inner","color",n)}),document.querySelectorAll(".view-toggle").forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.view;this.setView(a)})}),document.getElementById("preview-btn").addEventListener("click",()=>this.showPreview()),document.getElementById("save-template-btn").addEventListener("click",()=>this.saveTemplate()),document.getElementById("continue-btn").addEventListener("click",()=>this.toggleRecipientsDrawer()),document.getElementById("send-test-btn").addEventListener("click",()=>this.sendTestEmail());const t=document.getElementById("final-send-btn");t&&t.addEventListener("click",()=>this.sendCampaign());const i=document.querySelector(".close-modal");i&&i.addEventListener("click",()=>{document.getElementById("preview-modal").style.display="none"});const s=document.getElementById("block-image-upload");s&&s.addEventListener("change",n=>this.handleImageFileSelect(n))}addBlock(e){const t="block_"+Date.now();let i="";switch(e){case"header":i={text:"Overskrift her"};break;case"text":i={text:"Skriv din tekst her..."};break;case"image":i={url:"https://images.unsplash.com/photo-1490730141103-6cac27aaab94?auto=format&fit=crop&w=800&q=80",alt:"Beskrivelse"};break;case"button":i={text:"Les mer",url:"#"};break;case"video":i={url:"",videoId:"",provider:"youtube"};break;case"columns":i={layout:"2-col",cols:[{type:"text",text:"Venstre kolonne..."},{type:"text",text:"Høyre kolonne..."}]};break;case"social":i={platforms:[{name:"facebook",url:"https://facebook.com/hiskingdomministry"},{name:"instagram",url:"https://instagram.com/hiskingdomministry"},{name:"youtube",url:"https://youtube.com/@HisKingdomMinistry"}]};break;case"logo":i={url:"../img/logo-hkm.png",width:100};break;case"divider":i={color:"#e2e8f0",thickness:2};break;case"spacer":i={height:32};break}this.blocks.push({id:t,type:e,content:i}),this.renderCanvas()}deleteBlock(e){this.blocks=this.blocks.filter(t=>t.id!==e),this.renderCanvas()}moveBlock(e,t){const i=this.blocks.findIndex(a=>a.id===e);if(i===-1)return;const s=i+t;if(s<0||s>=this.blocks.length)return;const n=this.blocks[i];this.blocks[i]=this.blocks[s],this.blocks[s]=n,this.renderCanvas()}setView(e){this.currentView=e,document.querySelectorAll(".view-toggle").forEach(i=>{i.classList.toggle("active",i.dataset.view===e)}),document.getElementById("canvas-scaler").classList.toggle("mobile",e==="mobile")}toggleRecipientsDrawer(){this.isRecipientsDrawerOpen=!this.isRecipientsDrawerOpen,document.getElementById("recipients-drawer").classList.toggle("open",this.isRecipientsDrawerOpen),document.body.classList.toggle("builder-recipients-open",this.isRecipientsDrawerOpen),this.isRecipientsDrawerOpen&&this.closeToolsUi();const t=document.getElementById("continue-btn");this.isRecipientsDrawerOpen?(t.innerHTML='<span class="btn-label">Tilbake til design</span><span class="material-symbols-outlined">arrow_back</span>',this.updateRecipientSummary()):t.innerHTML='<span class="btn-label">Velg mottakere</span><span class="material-symbols-outlined">arrow_forward</span>'}async updateRecipientSummary(){if(!(!window.firebaseService||!window.firebaseService.isInitialized))try{const t=(await window.firebaseService.db.collection("users").get()).size,i=Math.floor(t*.8),s=document.querySelector('input[value="all"]').nextElementSibling.querySelector(".opt-title");s&&(s.innerText=`Alle kontakter (${t})`);const n=document.getElementById("select-subscribers");n&&(n.nextElementSibling.innerText=`Legg til abonnenter (${i})`),this.totalUsers=t,this.subscribersCount=i,this.calculateEstimated()}catch(e){console.error("Summary update failed:",e)}}calculateEstimated(){const e=document.querySelector('input[name="send-to"]:checked');if(!e)return;const t=e.value==="all",i=document.getElementById("select-subscribers").checked;let s=0;t?s=this.totalUsers||0:(i&&(s+=this.subscribersCount||0),s+=this.selectedUserEmails.size,this.selectedSegments.size>0||this.selectedLabels.size>0);const n=document.getElementById("estimated-count");n&&(n.innerText=s)}async toggleUserSelectionList(){const e=document.getElementById("user-selection-list");if(!e)return;e.style.display==="none"?(e.style.display="block",await this.loadUserSelection()):e.style.display="none"}async loadUserSelection(){const e=document.getElementById("user-selection-list");if(e){e.innerHTML='<div style="padding: 20px; text-align: center;"><span class="material-symbols-outlined rotating" style="animation: spin 1s linear infinite;">sync</span></div>';try{const t=await window.firebaseService.db.collection("users").limit(50).get();e.innerHTML="",t.forEach(i=>{const s=i.data(),n=document.createElement("div");n.className="manual-user-item",n.style.display="flex",n.style.alignItems="center",n.style.gap="12px",n.style.padding="10px",n.style.borderBottom="1px solid #f1f5f9";const a=this.selectedUserEmails.has(s.email);n.innerHTML=`
                    <input type="checkbox" value="${s.email}" ${a?"checked":""}>
                    <div style="font-size: 13px;">
                        <div style="font-weight: 700;">${s.firstName?s.firstName+" "+(s.lastName||""):s.displayName||"Navn ikke satt"}</div>
                        <div style="color: var(--text-muted);">${s.email}</div>
                    </div>
                `,n.querySelector("input").addEventListener("change",c=>{c.target.checked?this.selectedUserEmails.add(s.email):this.selectedUserEmails.delete(s.email),this.calculateEstimated()}),e.appendChild(n)})}catch{e.innerHTML='<p class="error">Kunne ikke hente kontakter.</p>'}}}async toggleSegmentsList(){const e=document.getElementById("segments-list");if(!e)return;e.style.display==="none"?(e.style.display="block",this.loadSegments()):e.style.display="none"}loadSegments(){const e=document.getElementById("segments-list");if(!e)return;const t=[{id:"admin",name:"Administratorer"},{id:"editor",name:"Redaktører"},{id:"medlem",name:"Medlemmer"},...this.customSegments||[]];let i=`
            <div style="padding: 10px; border-bottom: 1px solid #f1f5f9; display: flex; gap: 8px;">
                <input type="text" id="new-segment-name" placeholder="Nytt segment..." style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                <button onclick="builder.addNewSegment()" style="padding: 6px 10px; background: var(--accent-orange); color: white; border: none; border-radius: 4px; cursor: pointer;">+</button>
            </div>
        `;i+=t.map(s=>`
            <div class="manual-user-item" style="display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid #f1f5f9;">
                <input type="checkbox" value="${s.id}" ${this.selectedSegments.has(s.id)?"checked":""} onchange="builder.handleSegmentToggle('${s.id}', this.checked)">
                <div style="font-size: 13px; font-weight: 700;">${s.name}</div>
            </div>
        `).join(""),e.innerHTML=i}addNewSegment(){const e=document.getElementById("new-segment-name");if(!e||!e.value.trim())return;this.customSegments||(this.customSegments=[]);const t=e.value.trim();this.customSegments.push({id:t.toLowerCase().replace(/\s+/g,"-"),name:t}),e.value="",this.loadSegments()}handleSegmentToggle(e,t){t?this.selectedSegments.add(e):this.selectedSegments.delete(e),this.calculateEstimated()}async toggleLabelsList(){const e=document.getElementById("labels-list");if(!e)return;e.style.display==="none"?(e.style.display="block",this.loadLabels()):e.style.display="none"}loadLabels(){const e=document.getElementById("labels-list");if(!e)return;const i=[...["Medlem","Frivillig","Lovsang","Giver","Abonnent","Leder","Ny"],...this.customLabels||[]];let s=`
            <div style="padding: 10px; border-bottom: 1px solid #f1f5f9; display: flex; gap: 8px;">
                <input type="text" id="new-label-name" placeholder="Ny etikett..." style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                <button onclick="builder.addNewLabel()" style="padding: 6px 10px; background: var(--accent-orange); color: white; border: none; border-radius: 4px; cursor: pointer;">+</button>
            </div>
        `;s+=i.map(n=>`
            <div class="manual-user-item" style="display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid #f1f5f9;">
                <input type="checkbox" value="${n}" ${this.selectedLabels.has(n)?"checked":""} onchange="builder.handleLabelToggle('${n}', this.checked)">
                <div style="font-size: 13px; font-weight: 700;">${n}</div>
            </div>
        `).join(""),e.innerHTML=s}addNewLabel(){const e=document.getElementById("new-label-name");!e||!e.value.trim()||(this.customLabels||(this.customLabels=[]),this.customLabels.push(e.value.trim()),e.value="",this.loadLabels())}handleLabelToggle(e,t){t?this.selectedLabels.add(e):this.selectedLabels.delete(e),this.calculateEstimated()}handleImageClick(e,t=null){this.activeImageBlockId=e,this.activeColumnIndex=t,document.getElementById("block-image-upload").click()}async handleImageFileSelect(e){const t=e.target.files[0];if(!t||!this.activeImageBlockId)return;const i=this.blocks.find(s=>s.id===this.activeImageBlockId);if(i)try{const s=`newsletter/images/${Date.now()}_${t.name}`,n=await window.firebaseService.uploadImage(t,s);this.activeColumnIndex!==null&&i.type==="columns"?(i.content.cols[this.activeColumnIndex].url=n,i.content.cols[this.activeColumnIndex].type="image"):i.content.url=n,this.renderCanvas()}catch(s){console.error("Upload failed:",s),showToast("Kunne ikke laste opp bilde.","error")}finally{e.target.value="",this.activeColumnIndex=null}}updateVideoUrl(e,t){const i=this.blocks.find(a=>a.id===e);if(!i)return;const s=/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/,n=t.match(s);i.content.url=t,n&&n[1]&&(i.content.videoId=n[1]),this.renderCanvas()}toggleColumnType(e,t){const i=this.blocks.find(n=>n.id===e);if(!i)return;const s=i.content.cols[t];s.type==="text"?(s.type="image",s.url="https://images.unsplash.com/photo-1490730141103-6cac27aaab94?auto=format&fit=crop&w=800&q=80"):(s.type="text",s.text="Skriv tekst her..."),this.renderCanvas()}renderCanvas(){const e=document.getElementById("blocks-container");if(this.blocks.length===0){e.innerHTML=`
                <div class="empty-canvas-msg">
                    <span class="material-symbols-outlined">add_circle</span>
                    <p>Legg til blokker her for å starte designet ditt</p>
                </div>
            `;return}e.innerHTML="",this.blocks.forEach(t=>{const i=document.createElement("div");i.className="newsletter-block",i.dataset.id=t.id,i.dataset.type=t.type;let s="";switch(t.type){case"header":s=`<h1 class="block-h1" contenteditable="true">${t.content.text}</h1>`;break;case"text":s=`<div class="block-text" contenteditable="true">${t.content.text}</div>`;break;case"image":s=`
                        <div class="block-image-wrap" onclick="builder.handleImageClick('${t.id}')">
                            <img src="${t.content.url}" alt="${t.content.alt}" class="block-img">
                            <div class="image-overlay">
                                <span class="material-symbols-outlined">upload_file</span>
                                <span>Bytt bilde</span>
                            </div>
                        </div>`;break;case"button":s=`<div class="block-btn-wrap"><a href="${t.content.url}" class="block-btn" contenteditable="true">${t.content.text}</a></div>`;break;case"video":t.content.videoId?s=`
                            <div class="block-video-wrap">
                                <iframe width="100%" height="315" src="https://www.youtube.com/embed/${t.content.videoId}" frameborder="0" allowfullscreen></iframe>
                                <input type="text" class="video-url-input" placeholder="YouTube Link" value="${t.content.url}" onblur="builder.updateVideoUrl('${t.id}', this.value)">
                            </div>`:s=`
                            <div class="block-video-placeholder">
                                <span class="material-symbols-outlined">smart_display</span>
                                <input type="text" class="video-url-input" placeholder="Lim inn YouTube-link her..." onblur="builder.updateVideoUrl('${t.id}', this.value)">
                            </div>`;break;case"columns":s=`<div class="block-columns layout-${t.content.layout}">`,t.content.cols.forEach((n,a)=>{let o="";n.type==="text"?o=`<div class="col-text" contenteditable="true" data-col="${a}">${n.text}</div>`:o=`
                                <div class="col-image-wrap" onclick="builder.handleImageClick('${t.id}', ${a})">
                                    <img src="${n.url}" class="col-img">
                                    <div class="image-overlay sm">
                                        <span class="material-symbols-outlined">upload_file</span>
                                    </div>
                                </div>`,s+=`
                            <div class="column">
                                <div class="col-type-toggle" onclick="builder.toggleColumnType('${t.id}', ${a})">
                                    <span class="material-symbols-outlined">${n.type==="text"?"image":"notes"}</span>
                                </div>
                                ${o}
                            </div>`}),s+="</div>";break;case"social":s='<div class="block-social">',t.content.platforms.forEach(n=>{s+=`<a href="${n.url}" class="social-icon"><i class="fab fa-${n.name}"></i></a>`}),s+="</div>";break;case"logo":s=`
                        <div class="block-logo-wrap" style="text-align: center;">
                            <img src="${t.content.url}" style="width: ${t.content.width}px; height: auto;">
                        </div>`;break;case"divider":s=`<div class="block-divider" style="padding: 16px 0;"><hr style="border: none; border-top: ${t.content.thickness}px solid ${t.content.color}; margin: 0;"></div>`;break;case"spacer":s=`<div class="block-spacer" style="height: ${t.content.height}px"></div>`;break}i.innerHTML=`
                ${s}
                <div class="block-controls">
                    <button class="control-btn" onclick="builder.moveBlock('${t.id}', -1)"><span class="material-symbols-outlined">arrow_upward</span></button>
                    <button class="control-btn" onclick="builder.moveBlock('${t.id}', 1)"><span class="material-symbols-outlined">arrow_downward</span></button>
                    <button class="control-btn delete" onclick="builder.deleteBlock('${t.id}')"><span class="material-symbols-outlined">delete</span></button>
                </div>
            `,i.querySelectorAll('[contenteditable="true"]').forEach(n=>{n.addEventListener("blur",()=>{if(t.type==="columns"){const a=n.dataset.col;t.content.cols[a].text=n.innerHTML}else t.type==="button"?t.content.text=n.innerText:t.content.text=n.innerHTML})}),e.appendChild(i)})}showPreview(){const e=document.getElementById("preview-modal"),t=document.getElementById("preview-frame"),i=document.getElementById("newsletter-canvas").cloneNode(!0);i.querySelectorAll(".block-controls, input, .col-type-toggle").forEach(s=>s.remove()),i.querySelectorAll("[contenteditable]").forEach(s=>s.removeAttribute("contenteditable")),i.querySelectorAll(".image-overlay").forEach(s=>s.remove()),t.innerHTML="",t.appendChild(i),t.className=`preview-frame ${this.currentView}`,e.style.display="flex"}async saveTemplate(){if(!window.firebaseService||!window.firebaseService.isInitialized)return;const e=prompt("Navn på malen:","Nyhetsbrev Mal");if(e)try{const t={name:e,blocks:this.blocks,subject:document.getElementById("newsletter-subject").value,createdAt:new Date().toISOString()};await window.firebaseService.db.collection("newsletter_templates").add(t),showToast("Mal lagret!","success"),this.loadTemplates()}catch{showToast("Kunne ikke lagre mal.")}}async loadTemplates(){if(!(!window.firebaseService||!window.firebaseService.isInitialized))try{const e=document.getElementById("templates-list"),t=await window.firebaseService.db.collection("newsletter_templates").orderBy("createdAt","desc").get();if(t.empty){e.innerHTML='<p class="empty-msg">Ingen maler lagret ennå</p>';return}e.innerHTML="",t.forEach(i=>{const s=i.data(),n=document.createElement("div");n.className="template-item card",n.style.padding="12px",n.style.marginBottom="8px",n.style.cursor="pointer",n.innerHTML=`<div style="font-weight:600; font-size:14px;">${s.name}</div>
                                 <div style="font-size:11px; color:#64748b;">${new Date(s.createdAt).toLocaleDateString()}</div>`,n.onclick=()=>{confirm(`Last inn "${s.name}"?`)&&(this.blocks=s.blocks,document.getElementById("newsletter-subject").value=s.subject||"",this.renderCanvas())},e.appendChild(n)})}catch{}}sendTestEmail(){const e=window.firebaseService.auth.currentUser;if(!e)return showToast("Logg inn først","warning");const t=document.getElementById("newsletter-subject").value;if(this.blocks.length===0)return showToast("Legg til innhold før du sender en test.","error");showToast(`Sender en test-e-post av "${t}" til ${e.email}...`,"info"),console.log("Test Send Triggered:",{to:e.email,subject:t,blocks:this.blocks}),setTimeout(()=>{showToast("Test-e-post er sendt!","success")},1e3)}async sendCampaign(){const e=parseInt(document.getElementById("estimated-count").innerText)||0,t=document.getElementById("newsletter-subject").value;if(this.blocks.length===0)return showToast("Du kan ikke sende et tomt nyhetsbrev.","error");if(e===0)return showToast("Du må velge minst én mottaker eller målgruppe.","warning");if(confirm(`Er du sikker på at du vil sende "${t}" til ca. ${e} mottakere?`))try{const s=document.getElementById("final-send-btn"),n=s.innerHTML;s.disabled=!0,s.innerHTML='<span class="material-symbols-outlined rotating">sync</span> Sender...';const a={subject:t,recipientCount:e,blockCount:this.blocks.length,status:"sent",sentAt:new Date().toISOString(),sentBy:window.firebaseService.auth.currentUser.email};await window.firebaseService.db.collection("newsletter_campaigns").add(a),setTimeout(()=>{showToast(`Suksess! Nyhetsbrevet er nå lagt i kø for utsendelse til ${e} mottakere.`),s.disabled=!1,s.innerHTML=n,confirm("Vil du gå tilbake til dashbordet?")&&(window.location.href="index.html")},1500)}catch(s){console.error("Campaign send failed:",s),showToast("Det oppstod en feil under utsendelsen. Vennligst prøv igjen.");const n=document.getElementById("final-send-btn");n.disabled=!1,n.innerHTML="Gå til utsendelse"}}}window.builder||(window.builder=new d);document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll('input[name="send-to"]').forEach(s=>{s.addEventListener("change",()=>{window.builder&&window.builder.calculateEstimated()})});const l=document.getElementById("select-subscribers");l&&l.addEventListener("change",()=>{window.builder&&window.builder.calculateEstimated()});const e=document.getElementById("add-manual-contacts-btn");e&&e.addEventListener("click",()=>{window.builder&&window.builder.toggleUserSelectionList()});const t=document.getElementById("add-segment-btn");t&&t.addEventListener("click",()=>{window.builder&&window.builder.toggleSegmentsList()});const i=document.getElementById("add-label-btn");i&&i.addEventListener("click",()=>{window.builder&&window.builder.toggleLabelsList()})});
