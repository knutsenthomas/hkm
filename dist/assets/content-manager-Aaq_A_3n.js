const x=window.firebaseService;class P{constructor(){this.pageId=this.detectPageId(),this.currentDate=new Date;const e=document.body;e&&this.pageId&&e.classList.add(`page-${this.pageId}`),this.init(),this.agendaMonthsToShow=1}detectPageId(){const e=window.location.pathname;return e==="/"||e.endsWith("/")||e.includes("index.html")?"index":e.includes("arrangementer.html")||e.includes("events.html")||e.includes("eventos.html")?"arrangementer":e.includes("kalender.html")?"kalender":e.includes("arrangement-detaljer.html")||e.includes("event-details.html")||e.includes("detalles-evento.html")?"arrangement-detaljer":e.includes("blogg.html")||e.includes("blog.html")?"blogg":e.includes("blogg-post.html")||e.includes("blog-post.html")?"blogg-post":e.includes("undervisningsserier.html")||e.includes("teaching.html")?"undervisningsserier":e.includes("media.html")?"media":e.includes("om-oss.html")||e.includes("about.html")||e.includes("sobre-nosotros.html")?"om-oss":e.includes("kontakt.html")||e.includes("contact.html")||e.includes("contacto.html")?"kontakt":e.includes("donasjoner.html")||e.includes("donations.html")||e.includes("donaciones.html")?"donasjoner":e.includes("for-menigheter.html")||e.includes("for-churches.html")||e.includes("para-iglesias.html")?"for-menigheter":e.includes("for-bedrifter.html")||e.includes("for-businesses.html")||e.includes("para-empresas.html")?"for-bedrifter":e.includes("bnn.html")?"bnn":e.includes("youtube.html")?"youtube":e.includes("podcast.html")?"podcast":e.includes("undervisning.html")?"undervisning":e.includes("seminarer.html")?"seminarer":""}getLocalizedLink(e){let t=document.documentElement.lang||"no";if(t.includes("-")&&(t=t.split("-")[0]),t==="no")return e;if(window.i18n&&typeof window.i18n.mapFileName=="function")return window.i18n.mapFileName(e,t);const a={en:{"index.html":"index.html","om-oss.html":"about.html","arrangementer.html":"events.html","kontakt.html":"contact.html","donasjoner.html":"donations.html","for-menigheter.html":"for-churches.html","for-bedrifter.html":"for-businesses.html","bnn.html":"bnn.html","arrangement-detaljer.html":"event-details.html","blogg.html":"blog.html","blogg-post.html":"blog-post.html"},es:{"index.html":"index.html","om-oss.html":"sobre-nosotros.html","arrangementer.html":"eventos.html","kontakt.html":"contacto.html","donasjoner.html":"donaciones.html","for-menigheter.html":"para-iglesias.html","for-bedrifter.html":"para-empresas.html","bnn.html":"bnn.html","arrangement-detaljer.html":"detalles-evento.html","blogg.html":"blog.html","blogg-post.html":"blog-post.html"}};return a[t]&&a[t][e]||e}setLoading(e){const t=document.body;t&&(e?t.classList.add("cms-loading"):t.classList.remove("cms-loading"))}async init(){try{const t=localStorage.getItem("hkm_cache_settings_design");t&&this.applyGlobalSettings(JSON.parse(t));const a=localStorage.getItem("hkm_cache_settings_seo");a&&this.handleSEO(JSON.parse(a));const n=localStorage.getItem(`hkm_cache_page_${this.pageId}`);n&&this.updateDOM(JSON.parse(n));const i=localStorage.getItem("hkm_cache_hero_slides");if(i){const s=JSON.parse(i);s&&s.slides&&this.renderHeroSlides(s.slides)}}catch(t){console.warn("[ContentManager] Early cache read failed",t)}let e=window.firebaseService;if(!e||!e.isInitialized){let t=0;for(;(!window.firebaseService||!window.firebaseService.isInitialized)&&t<40;)await new Promise(a=>setTimeout(a,50)),t++}e=window.firebaseService;try{(!e||!e.isInitialized)&&console.warn("⚠️ Firebase failed to initialize in time. Content may be limited.");const[t,a,n]=await Promise.all([e?e.getPageContent(this.pageId):null,e?e.getPageContent("settings_design"):null,e?e.getPageContent("settings_seo"):null]);localStorage.setItem(`hkm_cache_page_${this.pageId}`,JSON.stringify(t)),localStorage.setItem("hkm_cache_settings_design",JSON.stringify(a)),localStorage.setItem("hkm_cache_settings_seo",JSON.stringify(n)),a&&this.applyGlobalSettings(a),t&&this.updateDOM(t),n&&this.handleSEO(n),await this.loadSpecializedContent()}catch(t){console.error("[ContentManager] Init error:",t)}finally{this.setLoading(!1),window.dispatchEvent(new CustomEvent("cmsContentLoaded"))}}async handleSEO(e){let t=null;const n=new URLSearchParams(window.location.search).get("id");if(n){const i=await x.getPageContent("collection_blog"),s=await x.getPageContent("collection_teaching"),l=[...Array.isArray(i)?i:(i==null?void 0:i.items)||[],...Array.isArray(s)?s:(s==null?void 0:s.items)||[]].find(o=>o.title===n||o.id===n);l&&(l.seoTitle||l.seoDescription||l.geoPosition)&&(t={title:l.seoTitle,description:l.seoDescription,geoPosition:l.geoPosition})}this.applySEO(e,t)}async loadSpecializedContent(){if(this.pageId==="index"){const e=await x.getPageContent("hero_slides");e&&e.slides&&(localStorage.setItem("hkm_cache_hero_slides",JSON.stringify(e)),this.renderHeroSlides(e.slides));const t=await this.loadEvents();this.renderEvents(t||[]);const a=await x.getPageContent("collection_blog"),n=Array.isArray(a)?a:(a==null?void 0:a.items)||[];n.length>0&&this.renderBlogPosts(n.slice(0,3),"#blogg .blog-grid");const i=await x.getPageContent("collection_teaching"),s=Array.isArray(i)?i:(i==null?void 0:i.items)||[],r=document.getElementById("siste-undervisning");s.length>0&&r&&(r.style.display="block",this.renderTeachingSeries(s.slice(0,3),"#front-teaching-grid"));const l=await this.loadCauses();this.renderCauses(l),this.enableHeroAnimations()}if(this.pageId==="blogg-post"&&await this.renderSingleBlogPost(),this.pageId==="arrangementer"){const e=await x.getPageContent("settings_integrations")||{},t=await this.loadEvents(),a=document.getElementById("arrangement-kalender");e.showMonthView===!0?(this.setupCalendarNavigation(),this.setCalendarEvents(t||[]),this.renderCalendarView(),a&&(a.style.display="block")):a&&(a.style.display="none");const n=document.querySelector(".events-page");e.showAgendaView!==!1?(this.renderEvents(t||[]),n&&(n.style.display="block")):n&&(n.style.display="none")}if(this.pageId==="kalender")if((await x.getPageContent("settings_integrations")||{}).showMonthView!==!1){const t=await this.loadEvents();this.setupCalendarNavigation(),this.setCalendarEvents(t||[]),this.renderCalendarView()}else{const t=document.querySelector(".calendar-section")||document.querySelector("main");if(t){const a=document.documentElement.lang||"no",n=this.getLocalizedLink("arrangementer.html"),i=a==="en"?"Calendar is temporarily disabled.":a==="es"?"El calendario está desactivado temporalmente.":"Kalenderen er midlertidig deaktivert.",s=a==="en"?"Please check our events in the list above.":a==="es"?"Consulte nuestros eventos en la lista de arriba.":"Vennligst sjekk våre arrangementer i listen over.",r=a==="en"?"See events":a==="es"?"Ver eventos":"Se arrangementer";t.innerHTML=`<div class="container" style="padding: 100px 20px; text-align: center;"><h2>${i}</h2><p>${s}</p><a href="${n}" class="btn btn-primary" style="margin-top: 20px;">${r}</a></div>`}}if(this.pageId==="arrangement-detaljer"&&await this.renderEventDetailsPage(),this.pageId==="blogg"){console.log("[ContentManager] Loading content for 'blogg' page...");try{const e=await x.getPageContent("collection_blog");console.log("[ContentManager] Blog data received:",e);const t=Array.isArray(e)?e:(e==null?void 0:e.items)||[];if(console.log("[ContentManager] Parsed blog items:",t),t.length>0)this.renderBlogPosts(t,".blog-page .blog-grid");else{console.warn("[ContentManager] No blog posts found in 'collection_blog'.");const a=document.querySelector(".blog-page .blog-grid");a&&(a.innerHTML='<p style="text-align:center; padding: 20px;">Ingen blogginnlegg funnet. Kjør seed-scriptet.</p>')}}catch(e){console.error("[ContentManager] Error loading blog posts:",e)}}if(this.pageId==="donasjoner"){const e=await this.loadCauses();this.renderCauses(e)}}async loadCauses(){try{const e=await x.getPageContent("collection_causes");return Array.isArray(e)?e:(e==null?void 0:e.items)||[]}catch(e){return console.warn("[ContentManager] Failed to load causes:",e),[]}}renderCauses(e){const t=document.querySelector(".causes-grid"),a=document.querySelector(".donations-page.section")||document.querySelector(".causes");if(!(!t||!a)){if(!e||e.length===0){a.style.display="none";return}a.style.display="block",t.innerHTML=e.map(n=>`
            <div class="cause-card">
                <div class="cause-image">
                    <img src="${n.imageUrl||"img/placeholder.jpg"}" alt="${n.title}">
                    ${n.tag?`<span class="cause-tag">${n.tag}</span>`:""}
                </div>
                <div class="cause-content">
                    <h3 class="cause-title">${n.title}</h3>
                    <p class="cause-description">${n.description}</p>
                    
                    ${n.goal?`
                    <div class="cause-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(n.raised/n.goal*100,100)}%"></div>
                        </div>
                        <div class="progress-stats">
                            <span>${n.raised?n.raised.toLocaleString():"0"} kr samlet inn</span>
                            <span>Mål: ${n.goal.toLocaleString()} kr</span>
                        </div>
                    </div>
                    `:""}
                    
                    <a href="${n.link||"#gi-gave"}" class="btn btn-primary btn-block">Støtt prosjektet</a>
                </div>
            </div>
        `).join("")}}async renderSingleBlogPost(){const e=document.getElementById("single-post-content"),t=document.getElementById("single-post-title"),a=document.getElementById("single-post-breadcrumb"),n=document.getElementById("single-post-date"),i=document.getElementById("single-post-category"),s=document.getElementById("blog-hero");if(!e)return;const l=new URLSearchParams(window.location.search).get("id");if(!l){e.innerHTML="<p>Fant ikke innlegget.</p>";return}const o=await x.getPageContent("collection_blog"),d=await x.getPageContent("collection_teaching"),c=Array.isArray(o)?o:(o==null?void 0:o.items)||[],g=Array.isArray(d)?d:(d==null?void 0:d.items)||[],h=c.find(v=>v.title===l||v.id===l),u=g.find(v=>v.title===l||v.id===l),m=h||u,f=!!u;if(!m){e.innerHTML="<p>Innholdet ble ikke funnet.</p>";return}if(t&&(t.textContent=m.title||"Blogginnlegg"),a&&(a.textContent=m.title||"Blogginnlegg"),n){const v=m.date?this.formatDate(m.date):"";n.innerHTML=`<i class="far fa-calendar"></i> ${v}`}const w=document.getElementById("single-post-author");if(w){const v=m.author||"Ukjent forfatter";w.innerHTML=`<i class="fas fa-user"></i> ${v}`}if(i){const v=m.category||m.teachingType||(f?"Undervisning":"Ukategorisert");i.innerHTML=`<i class="fas fa-tag"></i> ${v}`}s&&m.imageUrl&&(s.style.backgroundImage=`linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${m.imageUrl}')`);let k=5;if(m.content){const I=this.stripHtml(this.parseBlocks(m.content)).split(/\s+/).filter(M=>M.length>0).length;k=Math.max(1,Math.ceil(I/225))}const y=document.getElementById("single-post-readingtime");if(y){const v=this.getTranslation("reading_time")||"min lesing";y.innerHTML=`<i class="far fa-clock"></i> ${k} ${v}`,y.style.display="inline-block"}const p=m.id||m.title;let b=1;if(p&&window.firebaseService&&window.firebaseService.db&&window.firebase&&window.firebase.firestore)try{const v=window.firebaseService.db.collection("blog_stats").doc(p),I=await v.get();I.exists&&typeof I.data().views<"u"&&(b=I.data().views+1),v.set({views:window.firebase.firestore.FieldValue.increment(1)},{merge:!0}).catch(M=>{console.warn("[ContentManager] Kunne ikke oppdatere visninger, kanskje manglende tilgang:",M)})}catch(v){console.warn("[ContentManager] Feil ved henting av visninger:",v)}let E=document.getElementById("single-post-views");if(!E&&document.querySelector(".blog-meta")&&(E=document.createElement("span"),E.id="single-post-views",y&&y.parentNode?y.parentNode.appendChild(E):document.querySelector(".blog-meta").appendChild(E)),E){const v=this.getTranslation("views")||"visninger";E.innerHTML=`<i class="far fa-eye"></i> ${b} ${v}`,E.style.display="inline-block"}e.innerHTML=this.parseBlocks(m.content)||"<p>Dette innlegget har foreløpig ikke noe innhold.</p>";const L=document.getElementById("post-skeleton");L&&(L.style.display="none"),e.style.display="block",requestAnimationFrame(()=>{e.style.opacity="0",e.style.transition="opacity 0.4s ease",requestAnimationFrame(()=>{e.style.opacity="1"})});const H=document.getElementById("single-post-title"),_=document.getElementById("blog-meta-row");H&&(H.style.opacity="1"),_&&(_.style.opacity="1");const D=document.getElementById("back-btn");D&&(f?(D.href="media.html#teaching-section",D.innerHTML='<i class="fas fa-arrow-left" style="margin-right:8px;"></i> Tilbake til undervisning'):(D.href="blogg.html",D.innerHTML='<i class="fas fa-arrow-left" style="margin-right:8px;"></i> Tilbake til blogg'));const T=document.getElementById("single-post-author-box");if(T)if(m.tags&&Array.isArray(m.tags)&&m.tags.length>0){T.style.display="block",T.style.background="#f8fafc",T.style.padding="20px";const v=`<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                    ${m.tags.map(I=>`<span class="blog-tag">${I}</span>`).join("")}
                </div>`;T.innerHTML=`
                    <h4 style="margin: 0; font-size: 1rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Emner</h4>
                    ${v}
                `}else T.style.display="none";const q=document.getElementById("single-post-related");if(q){let v=[],I="Relaterte innlegg",M="Les mer";if(f){I="Relatert undervisning",M="Les undervisning";const S=Array.isArray(m.seriesItems)?m.seriesItems:[];if(S.length>0)v=g.filter(C=>(S.includes(C.id)||S.includes(C.title))&&(C.id||C.title)!==p);else{const C=m.teachingType||m.category;v=g.filter($=>($.id||$.title)!==p).filter($=>C?($.teachingType||$.category)===C:!0).sort(($,N)=>new Date(N.date||0)-new Date($.date||0)).slice(0,3)}}else m.relatedPosts&&Array.isArray(m.relatedPosts)&&m.relatedPosts.length>0?v=c.filter(S=>(m.relatedPosts.includes(S.id)||m.relatedPosts.includes(S.title))&&(S.id||S.title)!==p):v=c.filter(S=>(S.id||S.title)!==p).sort((S,C)=>new Date(C.date)-new Date(S.date)).slice(0,3);v.length>0?(q.style.display="block",q.innerHTML=`
                    <h3 style="margin-bottom: 30px; font-size: 1.5rem; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                        ${I}
                    </h3>
                    <div class="blog-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px;">
                        ${v.map(S=>`
                            <article class="blog-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #f1f5f9; transition: transform 0.2s ease;">
                                <a href="${this.getLocalizedLink("blogg-post.html")}?id=${encodeURIComponent(S.id||S.title)}" style="text-decoration: none; color: inherit; display: block;">
                                    <div class="blog-image" style="height: 180px; overflow: hidden; position: relative;">
                                        <img src="${S.imageUrl||"https://images.unsplash.com/photo-1504052434569-70ad5836ab65?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80"}" 
                                             alt="${S.title}" 
                                             style="width: 100%; height: 100%; object-fit: cover;">
                                        ${S.category?`<span style="position: absolute; bottom: 10px; right: 10px; background: var(--secondary-color, #ff6b2b); color: white; padding: 2px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">${S.category}</span>`:""}
                                    </div>
                                    <div class="blog-content" style="padding: 20px;">
                                        <div class="blog-meta" style="font-size: 12px; color: #64748b; margin-bottom: 10px; display: flex; gap: 15px;">
                                            <span><i class="far fa-calendar"></i> ${S.date?this.formatDate(S.date):""}</span>
                                            ${S.author?`<span><i class="fas fa-user"></i> ${S.author}</span>`:""}
                                        </div>
                                        <h4 style="font-size: 1.1rem; margin-bottom: 15px; line-height: 1.4; font-weight: 700; color: #1e293b;">${S.title}</h4>
                                        <span style="color: var(--primary-color, #ff6b2b); font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 5px;">
                                           ${M} <i class="fas fa-arrow-right" style="font-size: 12px;"></i>
                                        </span>
                                    </div>
                                </a>
                            </article>
                        `).join("")}
                    </div>
                `):q.style.display="none"}}async loadEvents(e=!1){try{const{startIso:t,endIso:a}=this.getMonthRangeIso(this.currentDate),n=`hkm_events_${t}_${a}`;if(!e)try{const p=localStorage.getItem(n);if(p){const{timestamp:b,events:E}=JSON.parse(p);if(Date.now()-b<15*60*1e3)return E}}catch(p){console.warn("[ContentManager] Cache parse failed",p)}const i=this.currentDate.getFullYear(),s=this.getNorwegianHolidays(i),r=new Date(t),l=new Date(a),o=s.filter(p=>{const b=this.parseEventDate(p.start||p.date);return b?b>=r&&b<=l:!1});let d=[];const c=await x.getPageContent("settings_integrations"),g=(c==null?void 0:c.googleCalendar)||{},h=g.apiKey||"",u=Array.isArray(c==null?void 0:c.googleCalendars)?c.googleCalendars:[],m=u.length>0?u:g.calendarId?[{id:g.calendarId,label:g.label||"Arrangementer"}]:[];let f=[];h&&m.length>0&&(f=(await Promise.all(m.map(async b=>(await this.fetchGoogleCalendarEvents(h,b.id,t,a)||[]).map(L=>({...L,sourceId:`gcal:${b.id}`,sourceLabel:b.label||b.id}))))).flat());const w=await x.getPageContent("collection_events"),y=(Array.isArray(w)?w:(w==null?void 0:w.items)||[]).map(p=>({...p,sourceId:"manual",sourceLabel:"Interne arrangementer"}));if(f.length>0){d=f.map(b=>this._mergeEventWithFirestore(b,y));const p=y.filter(b=>!f.some(E=>b.gcalId&&b.gcalId===E.id||E.title===b.title&&this.isSameDay(this.parseEventDate(b.date),this.parseEventDate(E.start))));d=[...d,...p,...o]}else d=[...y,...o];try{localStorage.setItem(n,JSON.stringify({timestamp:Date.now(),events:d}))}catch(p){console.warn("[ContentManager] Failed to cache events",p)}return d}catch(t){return console.error("[ContentManager] loadEvents critical error:",t),[]}}setupCalendarNavigation(){const e=document.getElementById("prev-month"),t=document.getElementById("next-month"),a=document.getElementById("today-btn");e&&(e.onclick=async()=>{this.currentDate.setMonth(this.currentDate.getMonth()-1),this.agendaMonthsToShow=1,await this.refreshCalendarView()}),t&&(t.onclick=async()=>{this.currentDate.setMonth(this.currentDate.getMonth()+1),this.agendaMonthsToShow=1,await this.refreshCalendarView()}),a&&(a.onclick=async()=>{this.currentDate=new Date,this.agendaMonthsToShow=1,await this.refreshCalendarView()})}async refreshCalendarView(){const e=await this.loadEvents();this.setCalendarEvents(e||[]),this.renderCalendarView()}setCalendarEvents(e){this.calendarEvents=Array.isArray(e)?e:[];const t=this.collectCalendarSources(this.calendarEvents);this.activeCalendarSources?t.forEach(a=>{this.activeCalendarSources.has(a.id)||this.activeCalendarSources.add(a.id)}):this.activeCalendarSources=new Set(t.map(a=>a.id)),this.renderCalendarFilters(t)}collectCalendarSources(e){const t=new Map;return(e||[]).forEach(a=>{const n=a.sourceId||(a.isHoliday?"holiday":"unknown"),i=a.sourceLabel||(a.isHoliday?"Helligdager":"Kalender");t.has(n)||t.set(n,{id:n,label:i})}),Array.from(t.values())}renderCalendarFilters(e){var l;const t=document.querySelector(".calendar-container");if(!t)return;const a=t.querySelector(".calendar-header"),n=t.querySelector(".calendar-agenda-header");if(!a||!n)return;const i=this.ensureFilterRow(a,"calendar-header-filters",!0);(o=>{if(!e.length){o.innerHTML="";return}o.innerHTML=e.map(c=>{var u;const g=(u=this.activeCalendarSources)!=null&&u.has(c.id)?"active":"",h=this.escapeHtml(c.label);return`<button type="button" class="cal-filter-btn ${g}" data-source-id="${c.id}">${h}</button>`}).join(""),o.querySelectorAll(".cal-filter-btn").forEach(c=>{c.addEventListener("click",()=>{var h;const g=c.getAttribute("data-source-id");g&&((h=this.activeCalendarSources)!=null&&h.has(g)?(this.activeCalendarSources.delete(g),c.classList.remove("active")):(this.activeCalendarSources.add(g),c.classList.add("active")),this.renderCalendarView())})})})(i);const r=(l=n.parentElement)==null?void 0:l.querySelector(".calendar-agenda-filters");r&&r.remove()}ensureFilterRow(e,t,a=!1){const n=a?e.parentElement:e;let i=n==null?void 0:n.querySelector(`.${t}`);return i||(i=document.createElement("div"),i.className=`calendar-filters ${t}`,a?e.insertAdjacentElement("afterend",i):e.appendChild(i)),i}renderCalendarView(){const e=this.getFilteredEvents(this.calendarEvents||[]);this.renderCalendar(e),this.renderAgenda(e,"#calendar-agenda-list")}getFilteredEvents(e){return this.activeCalendarSources?this.activeCalendarSources.size===0?[]:(e||[]).filter(t=>{const a=t.sourceId||(t.isHoliday?"holiday":"unknown");return this.activeCalendarSources.has(a)}):e||[]}escapeHtml(e){return e==null?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}renderCalendar(e){const t=document.getElementById("calendar-grid"),a=document.getElementById("current-month-year");if(!t||!a)return;const n=["Januar","Februar","Mars","April","Mai","Juni","Juli","August","September","Oktober","November","Desember"];a.innerText=`${n[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;const i=t.querySelectorAll(".cal-day-header");t.innerHTML="",i.forEach(h=>t.appendChild(h));const s=this.currentDate.getFullYear(),r=this.currentDate.getMonth(),l=new Date(s,r,1).getDay(),o=l===0?6:l-1,d=new Date(s,r+1,0).getDate(),c=new Date(s,r,0).getDate(),g=Math.ceil((o+d)/7)*7;for(let h=0;h<g;h++){const u=document.createElement("div");u.className="cal-cell";let m,f;if(h<o)u.classList.add("other-month"),m=c-o+h+1,f=new Date(s,r-1,m);else if(h<o+d){m=h-o+1,f=new Date(s,r,m);const y=new Date;m===y.getDate()&&r===y.getMonth()&&s===y.getFullYear()&&u.classList.add("today")}else u.classList.add("other-month"),m=h-(o+d)+1,f=new Date(s,r+1,m);u.innerHTML=`<div class="day-num">${m}</div><div class="cal-events"></div>`;const w=(e||[]).filter(y=>{const p=this.parseEventDate(y.start||y.date);return p?p.getDate()===f.getDate()&&p.getMonth()===f.getMonth()&&p.getFullYear()===f.getFullYear():!1}),k=u.querySelector(".cal-events");w.forEach(y=>{const p=document.createElement("div");p.className="cal-event-tag",p.innerText=y.title;const b=y.start||y.date,E=this.parseEventDate(b),L=this.eventHasTime(b),H=E&&L?E.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit"}):"Tid ikke satt";p.title=`${y.title}
Kl: ${H}
${y.location||""}`;const _=this.getEventKey(y);p.setAttribute("data-event-key",_),p.classList.add("event-modal-trigger"),k.appendChild(p)}),this.bindEventModalTriggers(k),t.appendChild(u)}this.setEventCache(e||[])}async fetchGoogleCalendarEvents(e,t,a,n){try{const i=a||new Date().toISOString(),s=n||"",r=s?`&timeMax=${encodeURIComponent(s)}`:"",l=`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(t)}/events?key=${e}&timeMin=${encodeURIComponent(i)}${r}&orderBy=startTime&singleEvents=true&maxResults=250`,d=await(await fetch(l)).json();return d.error?(console.error("❌ GCal Error:",d.error.message),[]):d.items.map(c=>({id:c.id,title:c.summary,description:c.description||"",location:c.location||"",start:c.start.dateTime||c.start.date,end:c.end.dateTime||c.end.date,link:c.htmlLink,hangoutLink:c.hangoutLink||null,conferenceData:c.conferenceData||null}))}catch(i){return console.error("❌ Failed to fetch Google Calendar events:",i),[]}}async fetchSingleGoogleCalendarEvent(e,t,a){try{const n=`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(t)}/events/${encodeURIComponent(a)}?key=${e}`,i=await fetch(n);if(!i.ok){if(i.status===404)return null;throw new Error(`GCal API responded with ${i.status}`)}const s=await i.json();return{id:s.id,title:s.summary,description:s.description||"",location:s.location||"",start:s.start.dateTime||s.start.date,end:s.end.dateTime||s.end.date,link:s.htmlLink,hangoutLink:s.hangoutLink||null,conferenceData:s.conferenceData||null,sourceId:`gcal:${t}`,sourceLabel:"Google Calendar"}}catch(n){return console.warn(`[ContentManager] Failed to fetch single event ${a}:`,n),null}}renderEvents(e){window.cmsLog&&window.cmsLog(`Viser ${e?e.length:0} arrangementer...`);const t=document.querySelector(".events-grid");if(!t){window.cmsLog&&window.cmsLog("FEIL: Fant ikke .events-grid");return}try{if(this.setEventCache(e),!e||e.length===0){t.innerHTML='<div class="events-empty-state" style="grid-column: 1/-1; display: block; width: 100%; padding: 40px; text-align: center; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; color: var(--text-dark);"><h3 style="margin-bottom: 10px;">Ingen kommende arrangementer</h3><p>Vi har foreløpig ingen planlagte arrangementer i kalenderen.</p></div>';return}if(window.cmsLog&&e.length>0)try{console.log("[CMS] First event:",e[0])}catch{}const a=(e||[]).filter(s=>!s.isHoliday),i=(this.pageId==="index"?a.slice(0,3):a).map(s=>{try{const r=this.getEventKey(s),l=s.start||s.date,o=this.parseEventDate(l),d=this.eventHasTime(l),c=o?o.getDate():"--",g=document.documentElement.lang||"no",h=g==="en"?"en-US":g==="es"?"es-ES":"nb-NO",u=o?o.toLocaleString(h,{month:"short"}).replace(".",""):"--",m=u.charAt(0).toUpperCase()+u.slice(1),f=o?o.toLocaleDateString(h,{day:"numeric",month:"long",year:"numeric"}):"",w=this._getEventImage(s),k=s.title||"Arrangement";return`
                        <a href="${this.getLocalizedLink("arrangement-detaljer.html")+"?id="+encodeURIComponent(r)}" class="event-card">
                            <div class="event-image">
                                <div class="event-image-zoom">
                                    <img src="${w}" alt="${k}">
                                </div>
                                <div class="event-date">
                                    <span class="month">${m}</span>
                                    <span class="day">${c}</span>
                                </div>
                            </div>
                            <div class="event-content">
                                <h3 class="event-title">${s.title||"Uten tittel"}</h3>
                                <div class="event-meta">
                                    ${f?`<span>${f}</span>`:""}
                                </div>
                            </div>
                        </a>
                    `}catch(r){return console.error("Error rendering single event:",r,s),""}}).join("");t.innerHTML=i}catch(a){window.cmsLog&&window.cmsLog("CRASH i renderEvents: "+a.message),console.error(a)}}renderAgenda(e,t){const a=document.querySelector(t);if(!a)return;if(this.setEventCache(e||[]),!e||e.length===0){a.innerHTML='<li class="agenda-empty">Ingen kommende arrangementer er registrert.</li>';return}const n=[...e].sort((o,d)=>{const c=this.parseEventDate(o.start||o.date),g=this.parseEventDate(d.start||d.date),h=c?c.getTime():Number.POSITIVE_INFINITY,u=g?g.getTime():Number.POSITIVE_INFINITY;return h-u}),i=new Date(this.currentDate);i.setMonth(i.getMonth()+this.agendaMonthsToShow),i.setDate(1),i.setHours(0,0,0,0);const s=n.filter(o=>{const d=this.parseEventDate(o.start||o.date);return d&&d<i}),r=s.length<n.length,l=s.map(o=>{const d=this.getEventKey(o),c=o.start||o.date,g=this.parseEventDate(c),h=this.eventHasTime(c),u=document.documentElement.lang||"no",m=u==="en"?"en-US":u==="es"?"es-ES":"nb-NO",f=g?g.toLocaleDateString(m,{day:"2-digit"}):"--",w=g?g.toLocaleDateString(m,{month:"short"}).replace(".",""):"--",k=g?g.toLocaleDateString(m,{weekday:"short"}).replace(".",""):"",y=g&&h?g.toLocaleTimeString(m,{hour:"2-digit",minute:"2-digit"}):"",p=y||"Tid ikke satt",b=o.location||"Sted ikke satt";return`
                < li class="calendar-agenda-item" >
                    <div class="agenda-date-col">
                        <span class="agenda-day">${f}</span>
                        <span class="agenda-month">${w}</span>
                        <span class="agenda-weekday">${k}</span>
                    </div>
                    <div class="agenda-time-col">
                        <span class="agenda-dot"></span>
                        <span class="agenda-time">${p}</span>
                    </div>
                    <div class="agenda-main">
                        <span class="agenda-title">${o.title}</span>
                        <span class="agenda-meta">${b}</span>
                    </div>
                    <button type="button" class="agenda-link event-modal-trigger" data-event-key="${d}">Detaljer</button>
                </li >
                `}).join("");if(a.innerHTML=l,r){const o=document.createElement("li");o.style.textAlign="center",o.style.padding="15px",o.style.listStyle="none";const d=document.createElement("button");d.className="btn btn-agenda-load",d.innerText="Last flere arrangementer",d.style.fontSize="14px",d.onclick=()=>{this.agendaMonthsToShow++,this.renderAgenda(e,t)},o.appendChild(d),a.appendChild(o)}this.bindEventModalTriggers(a)}setEventCache(e){this.eventCache=new Map,Array.isArray(e)&&e.forEach(t=>{const a=this.getEventKey(t);a&&this.eventCache.set(a,t)})}getEventKey(e){return e?e.id||`${e.title||"event"}| ${e.start||e.date||""} `:""}bindEventModalTriggers(e){const t=e.querySelectorAll(".event-modal-trigger");t.length&&t.forEach(a=>{a.addEventListener("click",()=>{var s;const n=a.getAttribute("data-event-key"),i=(s=this.eventCache)==null?void 0:s.get(n);i&&this.openEventModal(i)})})}openEventModal(e){const t=this.ensureEventModal(),a=t.querySelector(".event-modal-title"),n=t.querySelector(".event-modal-date"),i=t.querySelector(".event-modal-time"),s=t.querySelector(".event-modal-location"),r=t.querySelector(".event-modal-description"),l=t.querySelector(".event-modal-image"),o=t.querySelector(".event-modal-image-wrap"),d=e.start||e.date,c=this.parseEventDate(d),g=this.eventHasTime(d),h=document.documentElement.lang||"no",u=h==="en"?"en-US":h==="es"?"es-ES":"nb-NO",m=c?c.toLocaleDateString(u,{day:"2-digit",month:"long",year:"numeric"}):this.getTranslation("loading"),f=c&&g?c.toLocaleTimeString(u,{hour:"2-digit",minute:"2-digit"}):this.getTranslation("location_not_set");a.textContent=e.title||"Arrangement",n.innerHTML=`<i class="far fa-calendar-alt"></i> ${m}`,i.innerHTML=`<i class="far fa-clock"></i> ${f}`,s.innerHTML=`<i class="fas fa-map-marker-alt"></i> ${e.location||"Sted ikke satt"}`;const w=e.content||e.description||"";let k="";typeof w=="object"&&w.blocks?k=this.parseBlocks(w):k=this.sanitizeEventHtml(w),k?r.innerHTML=k:r.textContent="Beskrivelse kommer.";const y=this._getEventImage(e);l.src=y,l.alt=e.title||"Arrangement",o.style.display="block";const p=this.extractVideoLink(e),b=t.querySelector(".event-modal-video-link");p&&b?(b.innerHTML=`< a href = "${p}" target = "_blank" rel = "noopener noreferrer" class="btn btn-primary" style = "display: inline-flex; align-items: center; gap: 8px; margin-bottom: 12px;" > <i class="fas fa-video"></i> Bli med på nettmøtet</a > `,b.style.display="block"):b&&(b.style.display="none"),t.classList.add("active")}ensureEventModal(){let e=document.querySelector(".event-modal-overlay");e||(e=document.createElement("div"),e.className="event-modal-overlay",e.innerHTML=`
                < div class="event-modal" >
                    <div class="event-modal-image-wrap" style="display: none;">
                        <img class="event-modal-image" alt="">
                    </div>
                    <div class="event-modal-header">
                        <h3 class="event-modal-title"></h3>
                        <button type="button" class="event-modal-close" aria-label="Lukk">&times;</button>
                    </div>
                    <div class="event-modal-body">
                        <div class="event-modal-left">
                            <div class="event-modal-meta">
                                <span class="event-modal-date"></span>
                                <span class="event-modal-time"></span>
                                <span class="event-modal-location"></span>
                            </div>
                            <div class="event-modal-video-link" style="display: none;"></div>
                        </div>
                        <div class="event-modal-right">
                            <h4 class="event-modal-section-title">Mer om arrangement</h4>
                            <p class="event-modal-description"></p>
                        </div>
                    </div>
                </div >
                `,document.body.appendChild(e),e.addEventListener("click",n=>{n.target===e&&e.classList.remove("active")}),e.querySelector(".event-modal-close").addEventListener("click",()=>{e.classList.remove("active")}));const t=e.querySelector(".event-modal-body");return t&&!t.querySelector(".event-modal-left")&&(t.innerHTML=`
                < div class="event-modal-left" >
                    <div class="event-modal-meta">
                        <span class="event-modal-date"></span>
                        <span class="event-modal-time"></span>
                        <span class="event-modal-location"></span>
                    </div>
                    <div class="event-modal-video-link" style="display: none;"></div>
                </div >
                <div class="event-modal-right">
                    <h4 class="event-modal-section-title">Mer om arrangement</h4>
                    <p class="event-modal-description"></p>
                </div>
            `),e}sanitizeEventHtml(e){if(!e)return"";if(typeof e=="object")return e.html?this.sanitizeEventHtml(e.html):e.text?this.sanitizeEventHtml(e.text):e.content&&typeof e.content=="string"?this.sanitizeEventHtml(e.content):"";let t=String(e);return t=t.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,""),t=t.replace(/\son\w+="[^"]*"/gi,""),t=t.replace(/\son\w+='[^']*'/gi,""),/<[^>]+>/.test(t)||(t=t.replace(/\n/g,"<br>")),t.trim()}parseEventDate(e){if(!e)return null;if(e instanceof Date)return Number.isNaN(e.getTime())?null:e;if(typeof e=="string"){const a=e.trim(),n=a.match(/^(\d{2})[./](\d{2})[./](\d{4})(?:\s+(\d{2}):(\d{2}))?$/);if(n){const s=Number(n[1]),r=Number(n[2])-1,l=Number(n[3]),o=n[4]?Number(n[4]):0,d=n[5]?Number(n[5]):0,c=new Date(l,r,s,o,d);return Number.isNaN(c.getTime())?null:c}const i=a.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s](\d{2}):(\d{2}))?/);if(i){const s=Number(i[1]),r=Number(i[2])-1,l=Number(i[3]),o=i[4]?Number(i[4]):0,d=i[5]?Number(i[5]):0,c=new Date(s,r,l,o,d);return Number.isNaN(c.getTime())?null:c}}const t=new Date(e);return Number.isNaN(t.getTime())?null:t}eventHasTime(e){return!e||typeof e!="string"?!1:/T\d{2}:\d{2}/.test(e)||/\d{2}:\d{2}/.test(e)}getMonthRangeIso(e){const t=e.getFullYear(),a=e.getMonth(),n=new Date(t,a,1,0,0,0),i=new Date(t,a+12,0,23,59,59,999);return{startIso:n.toISOString(),endIso:i.toISOString()}}getNorwegianHolidays(e){const t=[];if(!e||Number.isNaN(e))return t;const a=s=>{const r=s.getFullYear(),l=String(s.getMonth()+1).padStart(2,"0"),o=String(s.getDate()).padStart(2,"0");return`${r}-${l}-${o}`},n=(s,r)=>{if(!(s instanceof Date)||Number.isNaN(s.getTime()))return;const l=new Date(s.getFullYear(),s.getMonth(),s.getDate()),o=a(l);t.push({id:`holiday - ${o} -${r} `,title:r,description:"Helligdag / kristen høytid",start:o,end:o,location:"Norge",isHoliday:!0,sourceId:"holiday",sourceLabel:"Helligdager"})};n(new Date(e,0,1),"1. nyttårsdag"),n(new Date(e,4,1),"Arbeidernes dag"),n(new Date(e,4,17),"Grunnlovsdagen"),n(new Date(e,11,25),"1. juledag"),n(new Date(e,11,26),"2. juledag");const i=this.calculateEasterSunday(e);if(i){const s=(r,l)=>{const o=new Date(r);return o.setDate(o.getDate()+l),o};n(s(i,-7),"Palmesøndag"),n(s(i,-3),"Skjærtorsdag"),n(s(i,-2),"Langfredag"),n(i,"1. påskedag"),n(s(i,1),"2. påskedag"),n(s(i,39),"Kristi himmelfartsdag"),n(s(i,49),"1. pinsedag"),n(s(i,50),"2. pinsedag")}return t}calculateEasterSunday(e){if(!e||Number.isNaN(e))return null;const t=e%19,a=Math.floor(e/100),n=e%100,i=Math.floor(a/4),s=a%4,r=Math.floor((a+8)/25),l=Math.floor((a-r+1)/3),o=(19*t+a-i-l+15)%30,d=Math.floor(n/4),c=n%4,g=(32+2*s+2*d-o-c)%7,h=Math.floor((t+11*o+22*g)/451),u=Math.floor((o+g-7*h+114)/31)-1,m=(o+g-7*h+114)%31+1;return new Date(e,u,m)}updateDOM(e){if(!e)return;const t=document.documentElement.lang||"no";if(t!=="no"){console.log("[ContentManager] Skipping updateDOM for translated page:",t);return}document.querySelectorAll("[data-content-key]").forEach(n=>{const i=n.getAttribute("data-content-key"),s=this.getValueByPath(e,i);if(s===void 0)return;if(n.tagName==="IMG"){n.src!==s&&(n.src=s);return}const r=n.classList.contains("page-hero")||n.classList.contains("hero-section"),l=i==="hero.backgroundImage"||i==="hero.bg"||i.endsWith(".backgroundImage")||i.endsWith(".bg"),o=n.classList.contains("page-hero-title")||n.classList.contains("hero-title")||n.classList.contains("page-title"),d=n.classList.contains("page-hero-subtitle")||n.classList.contains("hero-subtitle");if(r&&l){const h={blogg:"https://images.unsplash.com/photo-1499750310159-5b600aaf0320?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80",bnn:"https://images.unsplash.com/photo-1522202176988-66273c2fd55f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80","om-oss":"https://images.unsplash.com/photo-1529070538774-1843cb3265df?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80","for-menigheter":"https://images.unsplash.com/photo-1499750310159-5b600aaf0320?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=1080","for-bedrifter":"https://images.unsplash.com/photo-1499750310159-5b600aaf0320?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=1080"}[this.pageId]||"https://images.unsplash.com/photo-1499750310159-5b600aaf0320?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80",u=s||h,m=document.querySelector(".page-hero")||document.querySelector(".hero-section")||n;m&&(m.style.transition="background-image 0.7s cubic-bezier(0.4,0,0.2,1)",m.style.backgroundImage=`linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('${u}')`);return}if(o){if(typeof s=="string"&&s.startsWith("http")){const h={blogg:"Blogg & nyheter",bnn:"Business Network","om-oss":"Om Oss","for-menigheter":"For menigheter","for-bedrifter":"For bedrifter"}[this.pageId]||"Tittel";n.textContent=h}else n.textContent=s||{blogg:"Blogg & nyheter",bnn:"Business Network","om-oss":"Om Oss","for-menigheter":"For menigheter","for-bedrifter":"For bedrifter"}[this.pageId]||"Tittel";return}if(d){n.textContent=s||{bnn:"Et nettverk for kristne ledere og næringsdrivende som ønsker å bruke sine ressurser for Guds rike.","om-oss":"Lær mer om vår visjon, oppdrag og historie"}[this.pageId]||"";return}if(typeof s=="string"&&s.startsWith("http"))return;const c=String(s).trim(),g=(n.textContent||"").trim();if(n.classList.contains("funfact-number")){const h=parseInt(c)||0;h>0&&(n.setAttribute("data-target",String(h)),(n.getAttribute("data-animated")==="true"||g==="0"||g==="NaN")&&(n.textContent=h));return}g!==c&&(n.textContent=s)})}applyGlobalSettings(e){if(e.logoUrl&&document.querySelectorAll(".logo img").forEach(a=>a.src=e.logoUrl),e.logoText&&document.querySelectorAll(".logo span").forEach(a=>{a.textContent=e.logoText}),e.faviconUrl){let t=document.querySelector('link[rel="icon"]');t||(t=document.createElement("link"),t.rel="icon",document.head.appendChild(t)),t.href=e.faviconUrl}if(e.siteTitle&&this.pageId==="index"&&(document.title=e.siteTitle),e.mainFont&&(document.body.style.fontFamily=`'${e.mainFont}', sans-serif`,!document.getElementById("google-font-injection"))){const t=document.createElement("link");t.id="google-font-injection",t.href=`https://fonts.googleapis.com/css2?family=${e.mainFont.replace(/ /g,"+")}:wght@300;400;500;600;700&display=swap`,t.rel="stylesheet",document.head.appendChild(t)}e.fontSizeBase&&document.documentElement.style.setProperty("--fs-body",`${e.fontSizeBase}px`),e.fontSizeH1Desktop&&document.documentElement.style.setProperty("--fs-h1-desktop",`${e.fontSizeH1Desktop}px`),e.fontSizeH1Mobile&&document.documentElement.style.setProperty("--fs-h1-mobile",`${e.fontSizeH1Mobile}px`),e.fontSizeH2Desktop&&document.documentElement.style.setProperty("--fs-h2-desktop",`${e.fontSizeH2Desktop}px`),e.fontSizeH2Mobile&&document.documentElement.style.setProperty("--fs-h2-mobile",`${e.fontSizeH2Mobile}px`),e.primaryColor&&document.documentElement.style.setProperty("--primary-color",e.primaryColor)}applySEO(e,t=null){const a=this.pageId,n=e.pages&&e.pages[a]||{};let i=(t==null?void 0:t.title)||n.title||e.globalTitle||document.title;document.title=i;const s=(t==null?void 0:t.description)||n.description||e.globalDescription||"";this.updateMetaTag("description",s),this.updateMetaTag("keywords",e.globalKeywords||"");const r=(t==null?void 0:t.geoPosition)||n.geoPosition||e.geoPosition||"",l=n.geoPlacename||e.geoPlacename||"",o=e.geoRegion||"";r&&this.updateMetaTag("geo.position",r),l&&this.updateMetaTag("geo.placename",l),o&&this.updateMetaTag("geo.region",o),r&&this.updateMetaTag("ICBM",r),this.updateMetaTag("og:title",i,"property"),this.updateMetaTag("og:description",s,"property"),e.ogImage&&this.updateMetaTag("og:image",e.ogImage,"property"),this.updateMetaTag("twitter:card","summary_large_image"),this.updateMetaTag("twitter:title",i),this.updateMetaTag("twitter:description",s),e.ogImage&&this.updateMetaTag("twitter:image",e.ogImage)}updateMetaTag(e,t,a="name"){if(!t)return;let n=document.querySelector(`meta[${a}="${e}"]`);n||(n=document.createElement("meta"),n.setAttribute(a,e),document.head.appendChild(n)),n.setAttribute("content",t)}renderHeroSlides(e){const t=document.documentElement.lang||"no";if(t!=="no"){console.log("[ContentManager] Skipping renderHeroSlides for translated page:",t);return}const a=document.querySelector(".slider-container");if(a&&e&&e.length>0){const n=Array.from(a.querySelectorAll(".hero-slide")).map(s=>{var r,l,o,d,c,g,h,u;return{title:((l=(r=s.querySelector(".hero-title"))==null?void 0:r.textContent)==null?void 0:l.trim())||"",subtitle:((d=(o=s.querySelector(".hero-subtitle"))==null?void 0:o.textContent)==null?void 0:d.trim())||"",imageUrl:(((c=s.querySelector(".hero-bg"))==null?void 0:c.style.backgroundImage)||"").replace(/url\(["']?(.*?)["']?\)/,"$1")||"",btnText:((h=(g=s.querySelector(".btn"))==null?void 0:g.textContent)==null?void 0:h.trim())||"",btnLink:((u=s.querySelector(".btn"))==null?void 0:u.getAttribute("href"))||""}});e.length!==n.length||e.some((s,r)=>{const l=n[r];if(!l)return!0;const o=(s.title||"").trim(),d=(s.subtitle||"").trim(),c=(s.btnText||"").trim(),g=(s.btnLink||"").trim(),h=f=>(f||"").replace(/['"]/g,"").replace(/^https?:/,"").trim(),u=h(l.imageUrl),m=h(s.imageUrl);return o!==l.title||d!==l.subtitle||u!==m||c!==l.btnText||g!==l.btnLink})?(console.log("[ContentManager] Hero content changed or updated from dashboard, re-rendering..."),document.body.classList.remove("hero-animate"),a.innerHTML=e.map((s,r)=>`
                    <div class="hero-slide ${r===0?"active":""}">
                        <div class="hero-bg" style="background-image: url('${s.imageUrl}')"></div>
                        <div class="container hero-container">
                            <div class="hero-content">
                                <h1 class="hero-title">${s.title}</h1>
                                <p class="hero-subtitle">${s.subtitle}</p>
                                ${s.btnText?`
                                    <div class="slide-buttons">
                                        <a href="${s.btnLink}" class="btn btn-primary">${s.btnText}</a>
                                    </div>
                                `:""}
                            </div>
                        </div>
                    </div>
                `).join(""),window.heroSlider&&(window.heroSlider.stopAutoPlay(),window.heroSlider.slides=document.querySelectorAll(".hero-slide"),window.heroSlider.currentIndex=0,window.heroSlider.startAutoPlay()),this.enableHeroAnimations()):console.log("[ContentManager] Hero content matches DOM, skipping re-render to prevent flicker.")}}enableHeroAnimations(){this.pageId==="index"&&document.body.classList.add("hero-animate")}renderBlogPosts(e,t){const a=document.querySelector(t);a&&e.length>0&&(a.innerHTML=e.map(n=>`
                <article class="blog-card">
                    <div class="blog-image">
                        <img src="${n.imageUrl||"https://via.placeholder.com/600x400?text=Ingen+bilde"}" alt="${n.title}">
                        ${n.category?`<span class="blog-category" style="position: absolute; top: 15px; left: 15px; background: var(--secondary-color, #ff6b2b); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${n.category}</span>`:""}
                    </div>
                    <div class="blog-content" style="padding: 25px;">
                        <div class="blog-meta" style="display: flex; gap: 15px; font-size: 13px; color: #6c757d; margin-bottom: 10px;">
                            ${n.date?`<span><i class="fas fa-calendar-alt"></i> ${this.formatDate(n.date)}</span>`:""}
                            ${n.author?`<span><i class="fas fa-user"></i> ${n.author}</span>`:'<span><i class="fas fa-user"></i> Admin</span>'}
                        </div>
                        ${n.tags&&Array.isArray(n.tags)&&n.tags.length>0?`
                        <div class="blog-tags" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                            ${n.tags.map(i=>`<span style="font-size: 11px; background: #fff0ea; color: #ff6b2b; padding: 2px 8px; border-radius: 12px; font-weight: 600;">#${i}</span>`).join("")}
                        </div>
                        `:""}
                        <h3 class="blog-title" style="margin-bottom: 12px; font-size: 1.25rem;">${n.title}</h3>
                        <p class="blog-excerpt" style="color: #666; font-size: 14px; line-height: 1.6; margin-bottom: 20px;">${this.generateExcerpt(n.content,n.title)}...</p>
                        <a href="${this.getLocalizedLink("blogg-post.html")}?id=${encodeURIComponent(n.id||n.title)}" class="blog-link" style="color: var(--primary-color); font-weight: 600; text-decoration: none;">${this.getTranslation("read_more")} <i class="fas fa-arrow-right" style="margin-left: 5px;"></i></a>
                    </div>
                </article>
            `).join(""))}renderTeachingSeries(e,t){const a=document.querySelector(t);a&&e.length>0&&(a.innerHTML=e.map(n=>`
                <a href="${this.getLocalizedLink("blogg-post.html")}?id=${encodeURIComponent(n.id||n.title)}" class="media-card" style="text-decoration: none; color: inherit; display: block;">
                    <div class="media-thumbnail">
                        <img src="${n.imageUrl||"https://via.placeholder.com/600x400?text=Ingen+bilde"}" alt="${n.title}">
                        <div class="media-play-button">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        ${n.category?`<span class="media-duration" style="background: var(--primary-color); left: 10px; right: auto; padding: 3px 10px; border-radius: 4px;">${n.category}</span>`:""}
                    </div>
                    <div class="media-content">
                        <h3 class="media-title">${n.title}</h3>
                        <p class="media-description">${this.generateExcerpt(n.content,n.title)}...</p>
                        <div class="media-meta" style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px; color: #6c757d;"><i class="fas fa-user"></i> ${n.author||"His Kingdom"}</span>
                            <span style="font-size: 12px; color: #6c757d;"><i class="fas fa-calendar"></i> ${n.date?this.formatDate(n.date):""}</span>
                        </div>
                    </div>
                </a>
            `).join(""))}async renderEventDetailsPage(){const t=new URLSearchParams(window.location.search).get("id");if(!t){const o=document.querySelector(".event-main-content");o&&(o.innerHTML="<p>Arrangementet ble ikke funnet.</p>");return}let a=null;try{for(let o=0;o<localStorage.length;o++){const d=localStorage.key(o);if(d.startsWith("hkm_events_")){const{events:c}=JSON.parse(localStorage.getItem(d)),g=c.find(h=>this.getEventKey(h)===t||encodeURIComponent(this.getEventKey(h))===t);if(g){a=g,this.populateEventDetailsDOM(a);break}}}}catch{}const i=(await this.loadEvents()).find(o=>this.getEventKey(o)===t||encodeURIComponent(this.getEventKey(o))===t);i&&(a=i,this.populateEventDetailsDOM(a));const s=await x.getPageContent("settings_integrations"),r=(s==null?void 0:s.googleCalendar)||{},l=r.apiKey;if(l){const o=Array.isArray(s==null?void 0:s.googleCalendars)?s.googleCalendars:[],d=o.length>0?o:r.calendarId?[{id:r.calendarId}]:[];for(const c of d)if(!t.includes("|")){const g=await this.fetchSingleGoogleCalendarEvent(l,c.id,t);if(g){const h=await x.getPageContent("collection_events"),u=Array.isArray(h)?h:(h==null?void 0:h.items)||[];a=this._mergeEventWithFirestore(g,u),this.populateEventDetailsDOM(a);break}}}if(!a){const o=document.querySelector(".event-main-content");o&&(o.innerHTML='<div class="alert alert-info">Fant ikke arrangementet eller det har passert datoen for visning.</div>');const d=document.querySelector(".page-title");d&&d.textContent==="Laster..."&&(d.textContent="Fant ikke arrangement");const c=document.querySelector(".breadcrumbs span:last-child");c&&(c.textContent="Ikke funnet");const g=document.querySelector(".event-sidebar");g&&(g.style.display="none")}}getTranslation(e){const t=document.documentElement.lang||"no",a={no:{loading:"Laster...",loading_recent:"Laster nylige...",no_events:"Ingen andre arrangementer.",not_found:"Arrangementet ble ikke funnet.",location_not_set:"Sted ikke oppgitt",no_description:"Ingen beskrivelse tilgjengelig.",read_more:"Les mer",reading_time:"min lesing",views:"visninger"},en:{loading:"Loading...",loading_recent:"Loading recent...",no_events:"No other events.",not_found:"Event not found.",location_not_set:"Location not specified",no_description:"No description available.",read_more:"Read more",reading_time:"min read",views:"views"},es:{loading:"Cargando...",loading_recent:"Cargando recientes...",no_events:"No hay otros eventos.",not_found:"Evento no encontrado.",location_not_set:"Ubicación no especificada",no_description:"No hay descripción disponible.",read_more:"Leer más",reading_time:"min lectura",views:"vistas"}};return a[t]&&a[t][e]||a.no[e]||e}populateEventDetailsDOM(e){if(!e)return;const t=document.documentElement.lang||"no",a=t==="en"?"en-US":t==="es"?"es-ES":"nb-NO",n=document.getElementById("hero-title"),i=document.getElementById("event-title"),s=document.getElementById("breadcrumb-current"),r=document.getElementById("event-hero-image"),l=document.getElementById("event-description"),o=document.getElementById("event-time"),d=document.getElementById("event-location"),c=e.start||e.date,g=this.parseEventDate(c),h=this.eventHasTime(c);n&&(n.textContent=e.title),i&&(i.textContent=e.title),s&&(s.textContent=e.title);const u=this._getEventImage(e);if(r&&u){r.style.opacity="0",r.style.visibility="hidden",r.classList.remove("fade-in");const f=new window.Image;f.onload=function(){r.src=u,r.style.visibility="visible",r.style.opacity="1",r.classList.add("fade-in");const w=document.querySelector(".page-hero");w&&(w.style.backgroundImage=`linear-gradient(rgba(0, 0, 0, 0.45), rgba(0, 0, 0, 0.45)), url('${u}')`)},f.onerror=function(){r.src="../img/placeholder-event.jpg",r.style.visibility="visible",r.style.opacity="1",r.classList.add("fade-in")},f.src=u}const m=e.description||e.content||"";if(l){const f=this.sanitizeEventHtml(m)||`<p>${this.getTranslation("no_description")}</p>`;l.innerHTML=f}if(o&&g){let w=g.toLocaleDateString(a,{day:"numeric",month:"long",year:"numeric"});if(h){const k=g.toLocaleTimeString(a,{hour:"2-digit",minute:"2-digit"});w+=`, ${t==="en"?"at":t==="es"?"a las":"kl."} ${k}`}o.textContent=w}d&&(d.textContent=e.location||this.getTranslation("location_not_set")),this.populateSidebarRecentEvents()}async populateSidebarRecentEvents(){const e=document.getElementById("recent-events-sidebar");if(!e)return;const t=document.documentElement.lang||"no",a=t==="en"?"en-US":t==="es"?"es-ES":"nb-NO",n=await this.loadEvents(),s=new URLSearchParams(window.location.search).get("id"),r=n.filter(l=>this.getEventKey(l)!==s).slice(0,3);if(r.length===0){e.innerHTML=`<p>${this.getTranslation("no_events")}</p>`;return}e.innerHTML=r.map(l=>{const o=this.getEventKey(l),d=this._getEventImage(l),c=this.parseEventDate(l.start||l.date),g=c?c.toLocaleDateString(a,{day:"numeric",month:"short"}):"";return`
                <div class="recent-event-item">
                    <img src="${d}" alt="${l.title}" class="recent-event-img">
                    <div class="recent-event-info">
                        <h4><a href="${this.getLocalizedLink("arrangement-detaljer.html")}?id=${o}">${l.title}</a></h4>
                        <span class="recent-event-date">${g}</span>
                    </div>
                </div>
            `}).join("")}extractVideoLink(e){if(e.hangoutLink)return e.hangoutLink;if(e.conferenceData&&e.conferenceData.entryPoints){const n=e.conferenceData.entryPoints.find(i=>i.entryPointType==="video");if(n&&n.uri)return n.uri}const t=e.description||e.content||"",a=[/https?:\/\/[\w-]*\.?zoom\.us\/j\/[\w?=-]+/gi,/https?:\/\/meet\.google\.com\/[\w-]+/gi,/https?:\/\/teams\.microsoft\.com\/l\/meetup-join\/[\w\/%?=.-]+/gi,/https?:\/\/[\w.-]*webex\.com\/[\w\/\?=-]+/gi,/https?:\/\/meet\.jit\.si\/[\w-]+/gi];for(const n of a){const i=t.match(n);if(i)return i[0]}return e.videoLink?e.videoLink:e.meetingLink?e.meetingLink:null}stripHtml(e){if(!e)return"";let t=String(e).replace(/<[^>]+>/g," ");return t=t.replace(/\s+/g," ").trim(),t}generateExcerpt(e,t){if(!e)return"";let a="";typeof e=="string"?a=e:typeof e=="object"&&e.blocks?a=e.blocks.filter(i=>i.type!=="header").map(i=>{switch(i.type){case"paragraph":return`<p>${i.data.text}</p>`;case"list":const s=i.data.style==="ordered"?"ol":"ul",r=i.data.items.map(l=>`<li>${l}</li>`).join("");return`<${s}>${r}</${s}>`;default:return""}}).join(""):a=this.parseBlocks(e)||"";let n=this.stripHtml(a);if(t){const i=t.trim(),s=n.trim();s.toLowerCase().startsWith(i.toLowerCase())?n=s.substring(i.length).trim():n=s}return n.substring(0,120)}parseBlocks(e){return e?typeof e=="string"?e:typeof e=="object"&&e.blocks?e.blocks.map(t=>{var a;switch(t.type){case"header":return`<h${t.data.level} class="block-header">${t.data.text}</h${t.data.level}>`;case"paragraph":return`<p class="block-paragraph">${t.data.text}</p>`;case"list":const n=t.data.style==="ordered"?"ol":"ul",i=t.data.items.map(l=>`<li>${l}</li>`).join("");return`<${n} class="block-list">${i}</${n}>`;case"image":const s=t.data.caption?`<figcaption>${t.data.caption}</figcaption>`:"";return`<figure class="${["block-image",t.data.withBorder?"with-border":"",t.data.withBackground?"with-background":"",t.data.stretched?"stretched":""].join(" ")}"><img src="${t.data.file.url}" alt="${t.data.caption||""}">${s}</figure>`;case"quote":return`<blockquote class="block-quote"><p>${t.data.text}</p><cite>${t.data.caption}</cite></blockquote>`;case"delimiter":return'<div class="block-delimiter">***</div>';case"youtubeVideo":{const o=(((a=t.data)==null?void 0:a.url)||"").match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w-]{11})/),d=o?o[1]:null;return d?`
                            <div class="block-embed-wrapper" style="margin: 28px 0;">
                                <div class="block-embed" style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:12px; box-shadow: 0 4px 24px rgba(0,0,0,0.10);">
                                    <iframe
                                        src="https://www.youtube.com/embed/${d}"
                                        frameborder="0"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        allowfullscreen
                                        style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:12px;">
                                    </iframe>
                                </div>
                            </div>
                        `:""}case"embed":case"video":return`
                            <div class="block-embed-wrapper">
                                <div class="block-embed">
                                    <iframe src="${t.data.embed}" width="${t.data.width}" height="${t.data.height}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                                </div>
                                ${t.data.caption?`<div class="block-embed-caption">${t.data.caption}</div>`:""}
                            </div>
                        `;default:return""}}).join(""):"":""}generateEventImage(e){const t={prayer:"https://images.unsplash.com/photo-1511795409834-ef04bbd61622?w=800&h=600&fit=crop&q=80",worship:"https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=800&h=600&fit=crop&q=80",conference:"https://images.unsplash.com/photo-1516738901171-8eb4fc13bd20?w=800&h=600&fit=crop&q=80",teaching:"https://images.unsplash.com/photo-1524178232363-1fb2b075b655?w=800&h=600&fit=crop&q=80",bible:"https://images.unsplash.com/photo-1484480974693-6ca0a78fb36b?w=800&h=600&fit=crop&q=80",youth:"https://images.unsplash.com/photo-1529070538774-1843cb3265df?w=800&h=600&fit=crop&q=80",children:"https://images.unsplash.com/photo-1503454537195-1dcabb73ffb9?w=800&h=600&fit=crop&q=80",family:"https://images.unsplash.com/photo-1511895426328-dc8714191300?w=800&h=600&fit=crop&q=80",easter:"https://images.unsplash.com/photo-1490750967868-88aa4486c946?w=800&h=600&fit=crop&q=80",christmas:"https://images.unsplash.com/photo-1482517967863-00e15c9b44be?w=800&h=600&fit=crop&q=80",concert:"https://images.unsplash.com/photo-1501281668745-f7f57925c3b4?w=800&h=600&fit=crop&q=80",meeting:"https://images.unsplash.com/photo-1517048676732-d65bc937f952?w=800&h=600&fit=crop&q=80",gathering:"https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=800&h=600&fit=crop&q=80",community:"https://images.unsplash.com/photo-1506784983877-45594efa4cbe?w=800&h=600&fit=crop&q=80",default:"https://images.unsplash.com/photo-1438232992991-995b7058bbb3?w=800&h=600&fit=crop&q=80"};if(!e)return t.default;const a=e.toLowerCase(),n={bønn:"prayer",bønnemøte:"prayer",gudstjeneste:"worship",seminar:"conference",konferanse:"conference",undervisning:"teaching",bibel:"bible",bibelstudium:"bible",ung:"youth",ungdom:"youth",barn:"children",barnetreff:"children",familie:"family",påske:"easter",jul:"christmas",konsert:"concert",lovsang:"worship",tilbedelse:"worship",møte:"meeting",samling:"gathering",fellesskap:"community",test:"meeting"};for(const[i,s]of Object.entries(n))if(a.includes(i))return t[s]||t.default;return t.default}_getEventImage(e){return e?e.dashboardImage||e.imageUrl||e.image||e.imageLink||this.generateEventImage(e.title):this.generateEventImage("default")}_mergeEventWithFirestore(e,t){if(!t||!Array.isArray(t))return e;const a=t.find(n=>n.gcalId&&n.gcalId===e.id||n.title===e.title&&this.isSameDay(this.parseEventDate(n.date),this.parseEventDate(e.start)));return a?{...e,...a,title:a.title||e.title,description:a.content||a.description||e.description,imageUrl:a.dashboardImage||a.imageUrl||e.imageUrl,sourceId:e.sourceId||a.sourceId}:e}formatDate(e){if(!e)return"";try{return new Date(e).toLocaleDateString("no-NO",{day:"numeric",month:"long",year:"numeric"})}catch{return e}}isSameDay(e,t){return!e||!t?!1:e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}getValueByPath(e,t){return t.split(".").reduce((a,n)=>a?a[n]:void 0,e)}}function A(){window.contentManager||(window.contentManager=new P)}document.readyState==="loading"?window.addEventListener("DOMContentLoaded",A):A();
