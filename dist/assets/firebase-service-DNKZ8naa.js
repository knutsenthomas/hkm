class d{constructor(){this.app=null,this.db=null,this.auth=null,this.storage=null,this.isInitialized=!1;const i=localStorage.getItem("hkm_firebase_config");if(i)try{const e=JSON.parse(i);this.init(e);return}catch(e){console.error("Local config error:",e)}window.firebaseConfig&&window.firebaseConfig.apiKey!=="YOUR_API_KEY"&&this.init(window.firebaseConfig)}init(i){try{if(typeof firebase>"u"){console.error("❌ Firebase SDK not found. Make sure compat scripts are loaded.");return}firebase.apps.length?this.app=firebase.app():this.app=firebase.initializeApp(i),this.db=firebase.firestore(),this.auth=firebase.auth(),this.storage=firebase.storage(),this.isInitialized=!0,console.log("✅ Firebase initialized (Compat)"),this.db.enablePersistence({synchronizeTabs:!0}).catch(e=>{e.code==="failed-precondition"?console.warn("[FirebaseService] Persistence failed (multiple tabs open without sync)"):e.code==="unimplemented"&&console.warn("[FirebaseService] Persistence not supported by browser")})}catch(e){console.error("❌ Firebase initialization failed:",e)}}async getPageContent(i){if(!this.isInitialized)return null;try{const e=await this.db.collection("content").doc(i).get();return e.exists?e.data():null}catch(e){return console.error(`❌ Failed to load content for page '${i}':`,e),null}}async updatePageContent(i,e){if(!this.isInitialized)throw new Error("Firebase not initialized");await this.db.collection("content").doc(i).set(e,{merge:!0})}async savePageContent(i,e){return this.updatePageContent(i,e)}subscribeToPage(i,e){if(!this.isInitialized)return null;try{return this.db.collection("content").doc(i).onSnapshot(t=>{t.exists&&e(t.data())})}catch(t){return console.error(`❌ Failed to subscribe to page '${i}':`,t),null}}async login(i,e){if(!this.isInitialized)throw new Error("Firebase not initialized");return this.auth.signInWithEmailAndPassword(i,e)}async loginWithGoogle(){if(!this.isInitialized)throw new Error("Firebase not initialized");const i=new firebase.auth.GoogleAuthProvider;return this.auth.signInWithPopup(i)}async logout(){if(!this.isInitialized)throw new Error("Firebase not initialized");return this.auth.signOut()}async register(i,e){if(!this.isInitialized)throw new Error("Firebase not initialized");const t=await this.auth.createUserWithEmailAndPassword(i,e),r=t.user;return await this.db.collection("users").doc(r.uid).set({email:r.email,role:"medlem",createdAt:firebase.firestore.FieldValue.serverTimestamp()}),t}async subscribeNewsletter(i){if(!this.isInitialized)throw new Error("Firebase not initialized");return this.db.collection("newsletter_subscriptions").add({email:i,subscribedAt:firebase.firestore.FieldValue.serverTimestamp(),source:"website_footer"})}async connectToGoogle(){if(!this.isInitialized)throw new Error("Firebase not initialized");const i=new firebase.auth.GoogleAuthProvider;i.addScope("https://www.googleapis.com/auth/calendar.events");try{const e=await this.auth.signInWithPopup(i);return{user:e.user,accessToken:e.credential.accessToken}}catch(e){throw console.error("❌ Google Connection Failed:",e),e}}async getUserRole(i){if(!this.isInitialized)throw new Error("Firebase not initialized");const e=["thomas@hiskingdomministry.no"],t=this.auth&&this.auth.currentUser?this.auth.currentUser:null;if(t&&e.includes((t.email||"").toLowerCase()))return"superadmin";const r=await this.db.collection("users").doc(i).get();if(r.exists){const s=r.data().role;return typeof s=="string"&&s.trim()?s.trim().toLowerCase():"medlem"}return"medlem"}async sendEmailVerification(){if(!this.isInitialized)throw new Error("Firebase not initialized");const i=this.auth.currentUser;if(i)return i.sendEmailVerification();throw new Error("Ingen bruker er logget inn")}async updatePhoneNumber(i){if(!this.isInitialized)throw new Error("Firebase not initialized");const e=this.auth.currentUser;if(!e)throw new Error("Ingen bruker er logget inn");return this.db.collection("users").doc(e.uid).update({phone:i,updatedAt:firebase.firestore.FieldValue.serverTimestamp()})}async uploadImage(i,e,t={}){if(!this.isInitialized)throw new Error("Firebase not initialized");const r=this.storage.ref(e),s=typeof t.timeoutMs=="number"?t.timeoutMs:45e3;return new Promise((u,o)=>{const a=r.put(i);let l=!1;const c=setTimeout(()=>{l=!0,a.cancel(),o(new Error("Upload timeout"))},s);a.on("state_changed",null,n=>{clearTimeout(c),l||o(n)},async()=>{clearTimeout(c);try{const n=await r.getDownloadURL();u(n)}catch(n){o(n)}})})}async requestNotificationPermission(){if(!this.isInitialized||typeof firebase.messaging!="function"||!firebase.messaging.isSupported())return console.warn("Firebase Messaging is not initialized or supported in this browser."),null;const i=firebase.messaging();try{if(await Notification.requestPermission()==="granted"){console.log("Notification permission granted.");const t=await i.getToken({vapidKey:"BI2k24dp-3eJWtLSPvGWQkD00A_duNRCIMY_2ozLFI0-anJDamFBALaTdtzGYQEkoFz8X0JxTcCX6tn3P_i0YrA"});if(t){console.log("FCM Token:",t);const r=this.auth.currentUser;return r&&(await this.db.collection("users").doc(r.uid).update({fcmTokens:firebase.firestore.FieldValue.arrayUnion(t)}),console.log("FCM token saved to user profile.")),t}else return console.log("No registration token available. Request permission to generate one."),null}else return console.log("Unable to get permission to notify."),null}catch(e){return console.error("An error occurred while requesting permission or getting token:",e),null}}onAuthChange(i){this.isInitialized&&this.auth.onAuthStateChanged(i)}}window.firebaseService=new d;
