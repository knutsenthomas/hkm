import"./modulepreload-polyfill-B5Qt9EMX.js";import"./firebase-config-BNsh33Gw.js";import"./user-roles-D0mdCVLS.js";import"./firebase-service-DNKZ8naa.js";document.addEventListener("DOMContentLoaded",async()=>{console.log("[HKM] MinSide Auth Script loaded");const u=document.querySelectorAll(".btn-mode"),g=document.querySelectorAll(".auth-mode-section");u.forEach(e=>{e.addEventListener("click",()=>{const t=e.id.split("-")[1];w(t)})});function w(e){u.forEach(t=>{t.id===`mode-${e}`?(t.style.borderColor="var(--primary-orange)",t.style.color="var(--primary-orange)"):(t.style.borderColor="var(--border-color)",t.style.color="var(--text-main)")}),g.forEach(t=>{t.id===`section-${e}`?t.classList.add("active"):t.classList.remove("active")}),l()}const s=document.getElementById("feedback-box");function i(e,t){s.textContent=e,s.className=`feedback-message ${t}`,s.style.display="block"}function l(){s.style.display="none"}if(document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("login-email").value,r=document.getElementById("login-password").value,o=e.target.querySelector('button[type="submit"]');o.disabled=!0,o.textContent="Logger inn...",l();try{const n=window.firebaseService;if(!n||!n.isInitialized)throw new Error("Firebase mismatch");await n.login(t,r),await c()}catch(n){console.error(n),i(a(n),"error"),o.disabled=!1,o.textContent="Logg inn"}}),document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("register-email").value,r=document.getElementById("register-name").value,o=document.getElementById("register-password").value,n=document.getElementById("register-confirm").value,d=e.target.querySelector('button[type="submit"]');if(o!==n)return i("Passordene er ikke like.","error");d.disabled=!0,d.textContent="Oppretter profil...",l();try{await(await firebaseService.register(t,o)).user.updateProfile({displayName:r}),await c()}catch(m){console.error(m),i(a(m),"error"),d.disabled=!1,d.textContent="Opprett profil"}}),document.getElementById("magic-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("email-magic").value,r=e.target.querySelector('button[type="submit"]');r.disabled=!0,r.textContent="Sender link...",l();const o={url:window.location.href,handleCodeInApp:!0};try{await firebase.auth().sendSignInLinkToEmail(t,o),window.localStorage.setItem("emailForSignIn",t),i("Vi har sendt en magisk link til din e-post!","success"),r.textContent="Link sendt!"}catch(n){console.error(n),i(a(n),"error"),r.disabled=!1,r.textContent="Send meg link"}}),document.getElementById("google-login").addEventListener("click",async()=>{try{const e=window.firebaseService;if(!e||!e.isInitialized)throw new Error("Firebase mismatch");const r=(await e.loginWithGoogle()).user;await e.getUserRole(r.uid)||await firebase.firestore().collection("users").doc(r.uid).set({email:r.email,role:"medlem",createdAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),await c()}catch(e){console.error(e),i(a(e),"error")}}),firebase.auth().isSignInWithEmailLink(window.location.href)){let e=window.localStorage.getItem("emailForSignIn");e||(e=window.prompt("Bekreft din e-postadresse:")),firebase.auth().signInWithEmailLink(e,window.location.href).then(async()=>{window.localStorage.removeItem("emailForSignIn"),await c()}).catch(t=>{i(a(t),"error")})}async function c(){const e=window.firebaseService,t=firebase.auth().currentUser;if(!t||!e){window.location.href="index.html";return}let r="medlem";try{r=await e.getUserRole(t.uid)}catch(n){console.warn("Kunne ikke hente rolle:",n)}const o=window.HKM_PERMISSIONS&&Array.isArray(window.HKM_PERMISSIONS.ACCESS_ADMIN)&&window.HKM_PERMISSIONS.ACCESS_ADMIN.includes(r);window.location.href=o?"../admin/index.html":"index.html"}function a(e){switch(e.code){case"auth/user-not-found":return"Ingen bruker funnet.";case"auth/wrong-password":return"Feil passord.";case"auth/email-already-in-use":return"Denne e-posten er allerede i bruk.";case"auth/weak-password":return"Passordet m√• ha minst 6 tegn.";default:return e.message}}});
