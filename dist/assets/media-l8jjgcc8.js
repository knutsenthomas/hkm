const I={loadingVideos:{no:"Henter videoer fra YouTube...",en:"Fetching videos from YouTube...",es:"Obteniendo videos de YouTube..."},noVideosPlaylist:{no:'Ingen videoer funnet for <strong>{name}</strong> akkurat nå. Du kan se spillelisten direkte på YouTube <a href="{url}" target="_blank" style="color: var(--primary-color); text-decoration: underline;">her</a>.',en:'No videos found for <strong>{name}</strong> right now. You can watch the playlist directly on YouTube <a href="{url}" target="_blank" style="color: var(--primary-color); text-decoration: underline;">here</a>.',es:'No se encontraron videos para <strong>{name}</strong> en este momento. Puedes ver la lista de reproducción directamente en YouTube <a href="{url}" target="_blank" style="color: var(--primary-color); text-decoration: underline;">aquí</a>.'},noVideos:{no:"Ingen videoer funnet.",en:"No videos found.",es:"No se encontraron videos."},selectEpisode:{no:"Velg en episode",en:"Select an episode",es:"Selecciona un episodio"},prevEpisode:{no:"Forrige episode",en:"Previous episode",es:"Episodio anterior"},nextEpisode:{no:"Neste episode",en:"Next episode",es:"Siguiente episodio"},playbackSpeed:{no:"Avspillingshastighet",en:"Playback speed",es:"Velocidad de reproducción"},listenNow:{no:"Hør nå",en:"Listen now",es:"Escuchar ahora"},episode:{no:"Episode",en:"Episode",es:"Episodio"},noEpisodesCategory:{no:"Ingen episoder funnet i denne kategorien.",en:"No episodes found in this category.",es:"No se encontraron episodios en esta categoría."},loadingPodcastError:{no:"Kunne ikke laste episoder.",en:"Could not load episodes.",es:"No se pudieron cargar los episodios."},all:{no:"Alle",en:"All",es:"Todos"}};function b(e,t={}){const n=document.documentElement.lang||"no";return(I[e]&&I[e][n]||I[e]&&I[e].no||"").replace(/\{(\w+)\}/g,(o,r)=>t[r]!==void 0?t[r]:o)}document.addEventListener("DOMContentLoaded",async function(){const e=await F();K();const t="UCFbX-Mf7NqDm2a07hk6hveg",n=e&&e.youtubePlaylists?e.youtubePlaylists:"";(document.getElementById("youtube-grid")||window.location.pathname.includes("youtube.html"))&&z(t,n),document.getElementById("podcast-grid")&&ee(),e&&updatePlatformLinks(e)});async function F(){const e=window.firebaseService;return!e||!e.isInitialized?null:await e.getPageContent("settings_media")}function K(){const e=window.location.pathname.split("/").pop()||"index.html";document.querySelectorAll(".media-tab").forEach(a=>{a.getAttribute("href")===e?a.classList.add("active"):a.classList.remove("active")});const n=document.querySelectorAll(".media-card[data-category], .podcast-card[data-category]");if(n.length>0&&e==="media.html"){const a=document.querySelectorAll(".media-tab[data-tab]");a.forEach(o=>{o.addEventListener("click",function(r){const l=this.getAttribute("data-tab");l&&(r.preventDefault(),a.forEach(u=>u.classList.remove("active")),this.classList.add("active"),n.forEach(u=>{const f=u.getAttribute("data-category");l==="all"||f===l?(u.style.display="",setTimeout(()=>u.style.opacity="1",10)):(u.style.opacity="0",setTimeout(()=>u.style.display="none",300))}))})})}}async function z(e,t=""){const n=document.getElementById("youtube-grid"),a=document.querySelector(".media-content-section .container"),o=document.getElementById("youtube-categories");if(!n&&!a)return;let r=[];if(t&&(r=re(t)),window.location.pathname.includes("youtube.html")&&o&&r.length>0){o.innerHTML="";const c=document.createElement("button");c.textContent=b("all"),c.className="category-btn active",c.onclick=()=>A(),o.appendChild(c),r.forEach(i=>{const s=document.createElement("button");s.textContent=i.name,s.className="category-btn",s.onclick=()=>A(i.id),o.appendChild(s)})}const f="AIzaSy"+"ClPHHywl7Vr0naj2JnK_t-lY-V86gmKys",y="UCFbX-Mf7NqDm2a07hk6hveg";let d={},w=null,E=0;const $=6,v=document.getElementById("youtube-show-more");async function T(c){let i=[],s="";do{let m=`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${c}&key=${f}`;s&&(m+=`&pageToken=${s}`);const p=await(await fetch(m)).json();if(p.error)throw console.error("[YouTube API] PlaylistItems Error:",p.error),console.log("[YouTube API] Full error object:",p),new Error(p.error.message);p.items&&(i=i.concat(p.items.map(S=>({title:S.snippet.title,pubDate:S.snippet.publishedAt,link:`https://www.youtube.com/watch?v=${S.snippet.resourceId.videoId}`,thumbnail:S.snippet.thumbnails&&S.snippet.thumbnails.high?S.snippet.thumbnails.high.url:"",description:S.snippet.description||""})))),s=p.nextPageToken}while(s);return i}async function C(c){const i=c.replace(/^UC/,"UU");try{console.log(`[YouTube API] Prøver å hente uploads-spilleliste: ${i}`);const p=await T(i);if(p&&p.length>0)return p;console.warn("[YouTube API] Uploads-spilleliste var tom, prøver Search...")}catch(p){console.warn("[YouTube API] Henting av uploads-spilleliste feilet, prøver Search-endepunkt...",p)}let s=[],m="",g=0;do{let p=`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${c}&order=date&maxResults=50&type=video&key=${f}`;m&&(p+=`&pageToken=${m}`);const x=await(await fetch(p)).json();if(x.error)throw console.error("[YouTube API] Search Error:",x.error),new Error(x.error.message);x.items&&(s=s.concat(x.items.map(k=>{var _,H;return{title:k.snippet.title,pubDate:k.snippet.publishedAt,link:`https://www.youtube.com/watch?v=${k.id.videoId}`,thumbnail:k.snippet.thumbnails&&k.snippet.thumbnails.high?k.snippet.thumbnails.high.url:((H=(_=k.snippet.thumbnails)==null?void 0:_.default)==null?void 0:H.url)||"",description:k.snippet.description||""}}))),m=x.nextPageToken,g++}while(m&&g<3);return s}async function A(c="all"){if(n.innerHTML=`<div class="loader-container" style="grid-column: 1/-1; text-align: center; padding: 50px;"><div class="loader"></div><p style="margin-top: 15px; color: var(--text-muted);">${b("loadingVideos")}</p></div>`,o)if(o.querySelectorAll(".category-btn").forEach(s=>s.classList.remove("active")),!c||c==="all"){const s=o.querySelector(".category-btn");s&&s.classList.add("active")}else{const s=Array.from(o.children).find(m=>m.textContent===r.find(g=>g.id===c).name);s&&s.classList.add("active")}let i=[];if(c&&c!=="all")if(d[c])i=d[c];else{try{console.log(`Henter videoer for spilleliste via Data API: ${c}`),i=await T(c)}catch(s){console.warn(`Data API feilet for spilleliste ${c}, prøver RSS:`,s),i=[]}if(!i||i.length===0){const s=`https://www.youtube.com/feeds/videos.xml?playlist_id=${c}`,m=`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(s)}`;try{console.log(`Henter videoer for spilleliste via RSS: ${c}`);const p=await(await fetch(m)).json();p.status==="error"&&console.error(`[YouTube RSS] RSS2JSON Error for playlist ${c}:`,p.message),i=p.items||[]}catch(g){console.error(`Feil ved henting av spilleliste (RSS ${c}):`,g),i=[]}}d[c]=i||[]}else if(c==="all")if(d.all)i=d.all;else{try{console.log("Henter videoer fra kanal (ALL) via Data API"),i=await C(e||y)}catch(s){console.warn("Data API feilet for kanal (ALL), prøver RSS:",s),i=[]}if(!i||i.length===0){const s=`https://www.youtube.com/feeds/videos.xml?channel_id=${e}`,m=`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(s)}`;try{console.log("Henter videoer fra kanal (ALL) via RSS2JSON (Fallback)"),i=(await(await fetch(m)).json()).items||[]}catch(g){console.error("Feil ved henting av kanalvideoer (ALL/RSS):",g),i=[]}}d.all=i}w=c||"all",window.location.pathname.includes("youtube.html")?E=i.length:E=$,B()}function B(){let c=d[w]||[];if(n.innerHTML="",c.length===0){if(w&&w!=="all"){const i=r.find(g=>g.id===w),s=i?i.name:"denne spillelisten",m=`https://www.youtube.com/playlist?list=${w}`;n.innerHTML=`<p style="grid-column: 1/-1; text-align:center; color:var(--text-muted); padding: 40px;">${b("noVideosPlaylist",{name:s,url:m})}</p>`}else n.innerHTML=`<p style="grid-column: 1/-1; text-align:center; color:var(--text-muted);">${b("noVideos")}</p>`;v&&(v.style.display="none");return}c.slice(0,E).forEach(i=>{let s="";i.link&&i.link.includes("v=")&&(s=i.link.split("v=")[1]);const m=J(i,s);n.appendChild(m)}),v&&(E<c.length?v.style.display="":v.style.display="none")}v&&(v.onclick=function(){d[w],E+=$,B()}),A()}function J(e,t){const n=document.createElement("div");n.className="media-card",n.setAttribute("data-category","youtube");const a=new Date(e.pubDate).toLocaleDateString("no-NO"),o=t?`https://i.ytimg.com/vi/${t}/hqdefault.jpg`:"";n.innerHTML=`
        <div class="media-thumbnail" style="cursor: pointer; background: #2c3e50;">
            ${o?`<img src="${o}" alt="" style="display: none;">`:""}
            <div class="media-play-button"><i class="fab fa-youtube"></i></div>
        </div>
        <div class="media-content">
            <h3 class="media-title">${e.title}</h3>
            <div class="media-meta"><span><i class="far fa-calendar"></i> ${a}</span></div>
        </div>
    `;const r=n.querySelector("img");return r&&(r.onload=function(){if(this.src.includes("hqdefault.jpg")&&this.naturalWidth===120&&this.naturalHeight===90){this.style.display="none";return}this.style.display="block"},r.onerror=function(){this.style.display="none"},r.complete&&r.onload()),n.addEventListener("click",()=>window.open(e.link,"_blank")),n}let U=null,O=[],q={},D="all",R="newest",P=[],N=-1;const W={bibel:["bibel","skriften","ordet","testamente","vers","kapittel","skriftsted"],tro:["tro","tillit","håp","tvil","frelse","nåde","omvendelse"],bønn:["bønn","be","forbønn","stille","faste","bønnesvar"],undervisning:["undervisning","lære","serie","studie","disippel","lærling"]};function h(e){return Array.isArray(e)?e[0]||"":e&&typeof e=="object"?e._||"":e||""}function X(e){var n,a;const t=e==null?void 0:e.image;return Array.isArray(t)?((n=t[0])==null?void 0:n.url)||((a=t[0])==null?void 0:a.href)||"":t&&typeof t=="object"&&(t.url||t.href)||""}function G(e){var n,a,o,r;const t=e["itunes:image"];return Array.isArray(t)?((a=(n=t[0])==null?void 0:n.$)==null?void 0:a.href)||((o=t[0])==null?void 0:o.href)||"":t&&typeof t=="object"&&(((r=t.$)==null?void 0:r.href)||t.href)||""}function Q(e){const t=Array.isArray(e.guid)?e.guid[0]:e.guid;return t&&typeof t=="object"?t._||h(e.link)||h(e.title):t||h(e.link)||h(e.title)}function Z(e){const t=Q(e);if(q&&q[t])return q[t];const n=h(e.title),a=h(e.description)||h(e["itunes:summary"]),o=(n+" "+a).toLowerCase();for(const[r,l]of Object.entries(W))if(l.some(u=>o.includes(u)))return r;return"other"}async function ee(){var t,n;const e=document.getElementById("podcast-grid");if(e)try{const a=window.firebaseService;if(a&&a.isInitialized)try{const y=await a.getPageContent("settings_podcast_overrides");y&&y.overrides&&(q=y.overrides)}catch(y){console.warn("[Podcast] Kunne ikke hente overstyringer:",y)}const l=await(await fetch("https://getpodcast-42bhgdjkcq-uc.a.run.app")).json(),u=Array.isArray((t=l.rss)==null?void 0:t.channel)?l.rss.channel[0]:(n=l.rss)==null?void 0:n.channel,f=u==null?void 0:u.item;if(f){const y=Array.isArray(f)?f:[f];O=y.map((d,w)=>{var $,v,T,C,A;const E=h(d.pubDate);return{title:h(d.title),pubDate:E,dateObj:new Date(E),link:h(d.link),description:h(d.description)||h(d["itunes:summary"]),thumbnail:X(u)||G(d),audioUrl:(Array.isArray(d.enclosure)?(v=($=d.enclosure[0])==null?void 0:$.$)==null?void 0:v.url:(C=(T=d.enclosure)==null?void 0:T.$)==null?void 0:C.url)||((A=d.enclosure)==null?void 0:A.url),episodeNumber:y.length-w,category:Z(d)}}),te(),j()}}catch(a){console.error("[Podcast] Feil ved henting:",a),e.innerHTML=`<p class="text-danger">${b("loadingPodcastError")}</p>`}}function te(){const e=document.querySelectorAll("#podcast-categories [data-filter]"),t=document.getElementById("podcast-sort-select");e.forEach(n=>{n.addEventListener("click",()=>{e.forEach(a=>a.classList.remove("active")),n.classList.add("active"),D=n.getAttribute("data-filter"),j()})}),t&&t.addEventListener("change",n=>{R=n.target.value,j()})}function j(){const e=document.getElementById("podcast-grid");if(!e)return;let t=[...O];D!=="all"&&(t=t.filter(o=>o.category===D)),t.sort((o,r)=>R==="newest"?r.dateObj-o.dateObj:o.dateObj-r.dateObj),e.innerHTML="",P=t;const a=window.location.pathname.includes("podcast.html")?t.length:3;if(t.length===0){e.innerHTML=`<p style="grid-column: 1/-1; text-align:center; color:var(--text-muted); padding: 40px;">${b("noEpisodesCategory")}</p>`;return}t.slice(0,a).forEach((o,r)=>{const l=ne(o);e.appendChild(l)})}function ne(e,t){const n=document.createElement("div");n.className="podcast-card",n.setAttribute("data-category","podcast");const a=new Date(e.pubDate).toLocaleDateString("no-NO"),o=e.thumbnail||"https://images.unsplash.com/photo-1478737270239-2f02b77fc618?w=400&h=400&fit=crop";let r="";return e.description&&(r=e.description.replace(/<[^>]*>/g,"").substring(0,120)+"..."),n.innerHTML=`
        <div class="podcast-artwork">
            <img src="${o}" alt="${e.title}">
            <div class="podcast-play-overlay">
                <button class="play-btn-circle" data-audio="${e.audioUrl}">
                    <i class="fas fa-play"></i>
                </button>
            </div>
        </div>
        <div class="podcast-content">
            <span class="podcast-episode">${b("episode")} ${e.episodeNumber}</span>
            <h3 class="podcast-title">${e.title}</h3>
            <p class="podcast-description">${r}</p>
            <div class="podcast-meta"><span><i class="far fa-calendar"></i> ${a}</span></div>
            <div class="podcast-actions">
                <button class="btn-play-internal" data-audio="${e.audioUrl}"><i class="fas fa-play"></i> ${b("listenNow")}</button>
                <a href="${e.link}" target="_blank" class="btn-icon-outline"><i class="fas fa-external-link-alt"></i></a>
            </div>
        </div>
    `,n.querySelectorAll("[data-audio]").forEach(l=>{l.addEventListener("click",u=>{if(u.stopPropagation(),e.audioUrl){const f=P.indexOf(e);V(e.audioUrl,e.title,o,l,f)}})}),n}function V(e,t,n,a,o){document.getElementById("podcast-player-bar")||oe();const l=document.getElementById("global-audio-element"),u=document.querySelector(".player-info-title"),f=document.querySelector(".player-info-img");U===e?l.paused?(l.play(),L(!0,a)):(l.pause(),L(!1,a)):(U=e,typeof o=="number"&&o>=0&&(N=o),l.src=e,u.textContent=t,f.src=n,l.play(),document.getElementById("podcast-player-bar").classList.add("active"),L(!0,a))}function L(e,t){if(document.querySelectorAll(".play-btn-circle i, .btn-play-internal i, .player-control-play i").forEach(n=>{n.className="fas fa-play"}),e){t&&(t.querySelector("i").className="fas fa-pause");const n=document.querySelector(".player-control-play i");n&&(n.className="fas fa-pause")}}function oe(){const e=document.createElement("div");e.id="podcast-player-bar",e.innerHTML=`
        <div class="player-container">
            <audio id="global-audio-element"></audio>
            <div class="player-info">
                <img src="" class="player-info-img">
                <div class="player-info-text"><span class="player-info-title">${b("selectEpisode")}</span></div>
            </div>
            <div class="player-controls">
                <button class="player-control-btn player-control-prev" title="${b("prevEpisode")}"><i class="fas fa-step-backward"></i></button>
                <button class="player-control-btn player-control-play"><i class="fas fa-play"></i></button>
                <button class="player-control-btn player-control-next" title="${b("nextEpisode")}"><i class="fas fa-step-forward"></i></button>
            </div>
            <div class="player-progress-container">
                <span class="time-current">0:00</span>
                <div class="player-progress-bar"><div class="player-progress-fill"></div></div>
                <span class="time-total">0:00</span>
            </div>
            <div class="player-extra">
                <button class="player-control-btn player-speed" title="${b("playbackSpeed")}">1x</button>
                <button class="player-control-btn player-close"><i class="fas fa-times"></i></button>
            </div>
        </div>
    `,document.body.appendChild(e);const t=document.getElementById("global-audio-element"),n=e.querySelector(".player-control-play"),a=e.querySelector(".player-progress-fill"),o=e.querySelector(".player-progress-bar"),r=e.querySelector(".player-control-prev"),l=e.querySelector(".player-control-next"),u=e.querySelector(".player-speed");if(n.addEventListener("click",()=>{t.paused?(t.play(),L(!0)):(t.pause(),L(!1))}),o&&o.addEventListener("click",f=>{if(!t.duration)return;const y=o.getBoundingClientRect(),d=Math.min(Math.max((f.clientX-y.left)/y.width,0),1);t.currentTime=d*t.duration}),r&&r.addEventListener("click",()=>M(-1)),l&&l.addEventListener("click",()=>M(1)),u){const f=[1,1.25,1.5,2];let y=0;u.addEventListener("click",()=>{y=(y+1)%f.length;const d=f[y];t.playbackRate=d,u.textContent=d+"x"})}t.addEventListener("timeupdate",()=>{const f=t.currentTime/t.duration*100;a.style.width=f+"%",e.querySelector(".time-current").textContent=Y(t.currentTime)}),t.addEventListener("loadedmetadata",()=>{e.querySelector(".time-total").textContent=Y(t.duration)}),e.querySelector(".player-close").addEventListener("click",()=>{t.pause(),e.classList.remove("active"),L(!1)})}function M(e){if(!P||P.length===0||N<0)return;let t=N+e;t<0||t>=P.length||ae(t)}function ae(e){const t=P[e];if(!t)return;N=e;let n=document.querySelector(`.btn-play-internal[data-audio="${t.audioUrl}"]`);n||(n=document.querySelector(`.play-btn-circle[data-audio="${t.audioUrl}"]`));const a=t.thumbnail||"";V(t.audioUrl,t.title,a,n,e)}function Y(e){if(isNaN(e))return"0:00";const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,"0")}`}function re(e){return e?e.split(`
`).map(t=>{const n=t.split(":");if(n.length<2)return null;const a=n[0].trim();let o=n.slice(1).join(":").trim();if(o.includes("http"))try{const l=new URL(o).searchParams.get("list");l&&(o=l)}catch{const l=o.match(/[?&]list=([^&]+)/);l&&l[1]&&(o=l[1])}else{const r=o.match(/[?&]list=([^&]+)/);r&&r[1]&&(o=r[1])}return!a||!o?null:{name:a,id:o}}).filter(t=>t):[]}
